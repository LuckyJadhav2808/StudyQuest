<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyQuest - Your Gamified Productivity Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="StudyQuest.png" sizes="192x192">
    <link rel="icon" type="image/png" href="StudyQuest.png" sizes="512x512">
    <link rel="apple-touch-icon" href="StudyQuest.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <style>
        /* All existing CSS styles remain exactly the same */
        :root {
            --primary-dark: #1a1a2e;
            --primary: #16213e;
            --secondary: #0f3460;
            --accent: #e94560;
            --accent-light: #ff6b81;
            --success: #4cd97b;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #212529;
            --text-light: #f1f1f1;
            --text-muted: #adb5bd;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        /* Light theme variables */
        .light-theme {
            --primary-dark: #f8f9fa;
            --primary: #ffffff;
            --secondary: #e9ecef;
            --accent: #e94560;
            --accent-light: #ff6b81;
            --success: #4cd97b;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #1a1a2e;
            --dark: #f8f9fa;
            --text-light: #212529;
            --text-muted: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
            transition: var(--transition);
            position: relative;
        }

/* Environment Effects */
        .environment-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* Focus Emoji in Sidebar */
        .focus-emoji-container {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            position: relative;
        }

        .light-theme .focus-emoji-container {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .focus-emoji {
            font-size: 40px;
            transition: all 0.3s ease;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            position: relative;
            text-align: center;
            margin-bottom: 10px;
        }

        .focus-emoji.power-up {
            animation: pulse 1.5s infinite;
        }

        .focus-emoji.bounce {
            animation: bounce 0.5s;
        }

        .focus-emoji.pulse {
            animation: pulse 1s;
        }

        .emoji-power-up-indicator {
            position: absolute;
            top: 5px;
            right: 50%;
            transform: translateX(50%);
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            animation: float 3s infinite ease-in-out;
            z-index: 10;
        }

        .emoji-message {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 200px;
            text-align: center;
            z-index: 1000;
        }

        .emoji-message.show {
            opacity: 1;
        }

        .emoji-evolution {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: bold;
            display: none;
        }

        .focus-emoji.evolved .emoji-evolution {
            display: block;
        }

        /* All other existing CSS styles remain exactly the same */
        /* ... (All existing CSS code remains unchanged) ... */
        
        /* Mind Map Styles - Fixed */
        .mind-map-container {
            width: 100%;
            height: 400px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .light-theme .mind-map-container {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .mind-map-node {
            position: absolute;
            background: var(--primary);
            border: 2px solid var(--accent);
            border-radius: var(--border-radius);
            padding: 10px 15px;
            min-width: 120px;
            cursor: move;
            box-shadow: var(--box-shadow);
            z-index: 10;
        }

        .light-theme .mind-map-node {
            background: var(--primary);
        }

        .mind-map-node.active {
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(76, 217, 123, 0.3);
        }

        .mind-map-node .node-content {
            font-size: 14px;
            font-weight: 500;
        }

        .mind-map-node .node-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 5px;
        }

        .mind-map-connection {
            position: absolute;
            background: var(--accent);
            height: 2px;
            transform-origin: 0 0;
            z-index: 5;
        }

        /* Note Sharing */
        .note-sharing-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* Environment Selector */
        .environment-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .environment-option {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .light-theme .environment-option {
            background: rgba(0, 0, 0, 0.03);
        }

        .environment-option:hover, .environment-option.active {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .environment-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .environment-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .environment-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* New Feature Styles */
        .quick-templates {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .template-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: var(--text-light);
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .light-theme .template-btn {
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .template-btn:hover, .template-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .code-block {
            position: relative;
            margin: 15px 0;
            border-radius: 8px;
            overflow: hidden;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            font-family: monospace;
            font-size: 14px;
        }

        .copy-code-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
        }

        .copy-code-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .code-content {
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .light-theme .code-content {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }

        .session-resume {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--info);
        }

        .light-theme .session-resume {
            background: rgba(0, 0, 0, 0.03);
        }

        .seasonal-theme {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
        }

        .light-theme .seasonal-theme {
            background: rgba(0, 0, 0, 0.03);
        }

        .mood-checkin {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .mood-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
        }

        .mood-btn:hover, .mood-btn.active {
            border-color: var(--accent);
            transform: scale(1.1);
        }

        .session-templates {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .session-template {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .light-theme .session-template {
            background: rgba(0, 0, 0, 0.03);
        }

        .session-template:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .session-template.active {
            border-color: var(--success);
        }

        .study-quests {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .quest-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .light-theme .quest-card {
            background: rgba(0, 0, 0, 0.03);
        }

        .quest-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .quest-card.active {
            border-color: var(--success);
        }

        .quest-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .session-naming {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .session-name {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .session-name:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Animations */
        @keyframes bounce {
            0%, 20%, 60%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            80% {
                transform: translateY(-5px);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* Rest of the existing CSS remains the same */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: var(--box-shadow);
            z-index: 100;
            transition: var(--transition);
        }

        .light-theme .sidebar {
            background: rgba(255, 255, 255, 0.95);
        }

        .logo {
            display: flex;
            align-items: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .light-theme .logo {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .logo-icon {
            font-size: 28px;
            color: var(--accent);
            margin-right: 10px;
        }

        .logo-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 22px;
            background: linear-gradient(to right, var(--accent), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            list-style: none;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-light);
            text-decoration: none;
            transition: var(--transition);
            border-radius: 0 30px 30px 0;
            margin-right: 10px;
        }

        .light-theme .nav-link {
            color: var(--text-light);
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(233, 69, 96, 0.2);
            color: var(--accent-light);
        }

        .nav-link i {
            margin-right: 12px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .user-profile {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
        }

        .light-theme .user-profile {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin-right: 12px;
            color: white;
        }

        .user-info h3 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .user-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--box-shadow);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            transition: var(--transition);
            position: relative;
            z-index: 10;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 28px;
            display: flex;
            align-items: center;
        }

        .page-title i {
            margin-right: 12px;
            color: var(--accent);
        }

        .stats-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            align-items: center;
            min-width: 180px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
            min-width: 150px;
        }

        .light-theme .stat-card {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 22px;
            color: white;
        }

        .xp-icon {
            background: linear-gradient(135deg, #ff9a00, #ff6a00);
        }

        .streak-icon {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
        }

        .level-icon {
            background: linear-gradient(135deg, #00b4db, #0083b0);
        }

        .stat-info h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .widget {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .light-theme .widget {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .widget:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .widget-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .widget-title i {
            margin-right: 8px;
            color: var(--accent);
        }

        .widget-content {
            min-height: 150px;
        }

        /* Timetable Styles */
        .timetable {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
            overflow-x: auto;
        }

        .time-slot {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 5px;
            text-align: center;
            border-radius: 8px;
            font-size: 11px;
        }

        .light-theme .time-slot {
            background: rgba(0, 0, 0, 0.05);
        }

        .day-header {
            background: rgba(233, 69, 96, 0.2);
            padding: 8px 5px;
            text-align: center;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
        }

        .timetable-cell {
            height: 50px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px;
            text-align: center;
            font-size: 10px;
        }

        .light-theme .timetable-cell {
            background: rgba(0, 0, 0, 0.05);
        }

        .timetable-cell:hover {
            background: rgba(233, 69, 96, 0.2);
        }

        .timetable-cell.has-class {
            border-left: 4px solid var(--accent);
        }

        .class-subject {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .class-topic {
            font-size: 9px;
            color: var(--text-muted);
        }

        /* Task List Styles */
        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .task-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            margin-right: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .light-theme .task-checkbox {
            border: 2px solid rgba(0, 0, 0, 0.3);
        }

        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .task-checkbox.checked i {
            color: white;
            font-size: 12px;
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .task-due {
            font-size: 12px;
            color: var(--text-muted);
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .task-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
        }

        .task-btn:hover {
            color: var(--accent);
        }

        /* Progress Bar Styles */
        .progress-container {
            margin: 15px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .light-theme .progress-bar {
            background: rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent), var(--accent-light));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        /* Circular Progress */
        .circular-progress {
            width: 80px;
            height: 80px;
            position: relative;
            margin: 0 auto 10px;
        }

        .circular-progress svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .circular-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 8;
        }

        .light-theme .circular-bg {
            stroke: rgba(0, 0, 0, 0.1);
        }

        .circular-fill {
            fill: none;
            stroke: var(--accent);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 226;
            stroke-dashoffset: 226;
            transition: stroke-dashoffset 0.5s ease;
        }

        .circular-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-weight: 600;
        }

        /* Achievement Styles */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .achievement-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            transition: var(--transition);
        }

        .light-theme .achievement-card {
            background: rgba(0, 0, 0, 0.03);
        }

        .achievement-card.locked {
            opacity: 0.5;
        }

        .achievement-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 24px;
        }

        .light-theme .achievement-icon {
            background: rgba(0, 0, 0, 0.1);
        }

        .achievement-card.unlocked .achievement-icon {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
        }

        .achievement-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--primary);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            padding: 25px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .light-theme .modal-content {
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--accent);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
        }

        .light-theme .form-control {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--text-light);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        .light-theme .btn-secondary {
            background: rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .light-theme .btn-secondary:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Timer Styles */
        .timer-container {
            text-align: center;
            padding: 20px 0;
        }

        .timer-display {
            font-size: 64px;
            font-weight: 700;
            margin: 20px 0;
            font-family: 'Montserrat', sans-serif;
            text-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .timer-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .timer-btn.start {
            background: var(--success);
            color: white;
        }

        .timer-btn.pause {
            background: var(--warning);
            color: white;
        }

        .timer-btn.reset {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        .light-theme .timer-btn.reset {
            background: rgba(0, 0, 0, 0.1);
        }

        .timer-mode {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 8px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: var(--text-light);
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .light-theme .mode-btn {
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .mode-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Section Styles */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Quill Editor Styles */
        #editor {
            height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        .light-theme #editor {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .ql-toolbar.ql-snow {
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 8px 8px 0 0;
            background: rgba(255, 255, 255, 0.05);
        }

        .light-theme .ql-toolbar.ql-snow {
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            background: rgba(0, 0, 0, 0.05);
        }

        .ql-container.ql-snow {
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-top: none !important;
            border-radius: 0 0 8px 8px;
            background: rgba(255, 255, 255, 0.02);
        }

        .light-theme .ql-container.ql-snow {
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            background: rgba(0, 0, 0, 0.02);
        }

        .ql-editor {
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
        }

        .ql-snow .ql-stroke {
            stroke: var(--text-light);
        }

        .ql-snow .ql-fill {
            fill: var(--text-light);
        }

        .ql-snow .ql-picker-label {
            color: var(--text-light);
        }

        /* Notification Styles */
        .notification-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--accent);
        }

        .light-theme .notification-item {
            background: rgba(0, 0, 0, 0.03);
        }

        .notification-icon {
            font-size: 20px;
            margin-top: 2px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .notification-desc {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Calendar Styles */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .calendar-day {
            height: 80px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 8px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .light-theme .calendar-day {
            background: rgba(0, 0, 0, 0.05);
        }

        .calendar-day-header {
            height: 40px;
            background: rgba(233, 69, 96, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .calendar-event {
            background: var(--accent);
            border-radius: 4px;
            padding: 2px 5px;
            margin-top: 5px;
            font-size: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: white;
            cursor: pointer;
            position: relative;
        }

        .calendar-event:hover::after {
            content: 'Click to delete';
            position: absolute;
            top: -20px;
            left: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
        }

        /* Resource Manager Styles */
        .resource-category {
            margin-bottom: 25px;
        }

        .resource-category h3 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .resource-category h3 {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .resource-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .light-theme .resource-item {
            background: rgba(0, 0, 0, 0.03);
        }

        .resource-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .light-theme .resource-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .resource-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(233, 69, 96, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
            color: var(--accent);
        }

        .resource-info {
            flex: 1;
        }

        .resource-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .resource-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .resource-actions {
            display: flex;
            gap: 8px;
        }

        /* Settings Styles */
        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .settings-section h3 {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid transparent;
        }

        .theme-preview.dark {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
        }

        .theme-preview.light {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .theme-option.active .theme-preview {
            border-color: var(--accent);
        }

        /* Backup/Restore Styles */
        .backup-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        /* Smart Reminder Styles */
        .reminder-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border-left: 4px solid var(--info);
        }

        .light-theme .reminder-item {
            background: rgba(0, 0, 0, 0.03);
        }

        .reminder-item.warning {
            border-left-color: var(--warning);
        }

        .reminder-item.success {
            border-left-color: var(--success);
        }

        .reminder-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .reminder-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reminder-actions {
            display: flex;
            gap: 10px;
        }

        .reminder-action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .reminder-action-btn:hover {
            color: var(--accent);
        }

        /* Personalization Styles */
        .personalization-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .personalization-option {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .light-theme .personalization-option {
            background: rgba(0, 0, 0, 0.03);
        }

        .personalization-option:hover, .personalization-option.active {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .personalization-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .personalization-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .personalization-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Timer Extras */
        .timer-extras {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Notes View Mode */
        .notes-view-mode {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .view-mode-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: var(--text-light);
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .light-theme .view-mode-btn {
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .view-mode-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .notes-readonly {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            min-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .notes-readonly {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Notes List Styles - Fixed */
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .note-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .note-item {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .note-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .light-theme .note-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .note-item.active {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .note-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .note-preview {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .note-date {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Toast Styles */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: var(--success);
        }

        .toast-error {
            background: var(--accent);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .sidebar {
                width: 220px;
            }
            
            .timetable {
                grid-template-columns: 50px repeat(7, 1fr);
            }
            
            .timer-display {
                font-size: 48px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                width: 280px;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .main-content {
                padding: 70px 15px 15px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stats-container {
                width: 100%;
            }
            
            .stat-card {
                min-width: 100px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .timetable {
                grid-template-columns: 40px repeat(7, 1fr);
            }
            
            .time-slot, .day-header {
                font-size: 10px;
                padding: 5px 3px;
            }
            
            .timetable-cell {
                height: 40px;
                font-size: 8px;
            }
            
            .timer-display {
                font-size: 36px;
            }
            
            .achievements-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .personalization-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-container {
                flex-direction: column;
            }
            
            .stat-card {
                min-width: 100%;
            }
            
            .timer-display {
                font-size: 32px;
            }
            
            .timer-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .timer-btn {
                width: 100%;
                max-width: 200px;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar {
                grid-template-columns: repeat(7, 1fr);
            }
            
            .calendar-day {
                height: 60px;
                font-size: 12px;
            }
            
            .calendar-day-header {
                height: 30px;
                font-size: 12px;
            }
        }
        /* All other existing CSS styles remain exactly the same */
        /* ... (All existing CSS code remains unchanged) ... */
    </style>
</head>
<body>
    <!-- Environment Effects -->
    <div class="environment-effects" id="environment-effects"></div>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-dragon"></i></div>
                <div class="logo-text">StudyQuest</div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="timetable">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Timetable</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="tasks">
                        <i class="fas fa-tasks"></i>
                        <span>Tasks</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="notes">
                        <i class="fas fa-sticky-note"></i>
                        <span>Notes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="calendar">
                        <i class="fas fa-calendar"></i>
                        <span>Calendar</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="timer">
                        <i class="fas fa-clock"></i>
                        <span>Pomodoro Timer</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="subjects">
                        <i class="fas fa-book"></i>
                        <span>Subjects</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="resources">
                        <i class="fas fa-link"></i>
                        <span>Resources</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="progress">
                        <i class="fas fa-chart-line"></i>
                        <span>Progress</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="achievements">
                        <i class="fas fa-trophy"></i>
                        <span>Achievements</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="backup">
                        <i class="fas fa-download"></i>
                        <span>Backup & Restore</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
            
            <!-- Focus Emoji in Sidebar -->
            <div class="focus-emoji-container" id="focus-emoji-container">
                <div class="focus-emoji" id="focus-emoji"></div>
                <div class="emoji-message" id="emoji-message"></div>
                <div class="emoji-power-up-indicator" id="emoji-power-up-indicator"></div>
                <div class="emoji-evolution" id="emoji-evolution">Lv. 1</div>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">JS</div>
                <div class="user-info">
                    <h3 id="user-name">John Student</h3>
                    <p>Level <span id="user-level">1</span> Scholar</p>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-home"></i>
                        Dashboard
                    </h1>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-icon xp-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="xp-count">0</h3>
                                <p>Total XP</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon streak-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="streak-count">0</h3>
                                <p>Day Streak</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon level-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="level-count">1</h3>
                                <p>Current Level</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <!-- Timetable Widget -->
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-calendar-alt"></i>
                                Today's Schedule
                            </h2>
                            <a href="#" class="nav-link view-all" data-section="timetable">
                                View All
                            </a>
                        </div>
                        <div class="widget-content">
                            <div id="today-schedule">
                                <!-- Today's classes will be populated here -->
                                <p class="empty-state">No classes scheduled for today. Add some in the Timetable!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tasks Widget -->
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-tasks"></i>
                                Upcoming Tasks
                            </h2>
                            <a href="#" class="nav-link view-all" data-section="tasks">
                                View All
                            </a>
                        </div>
                        <div class="widget-content">
                            <ul class="task-list" id="dashboard-tasks">
                                <!-- Tasks will be populated by JavaScript -->
                                <li class="empty-state">No upcoming tasks. Add a task to get started!</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Pomodoro Widget -->
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-clock"></i>
                                Pomodoro Timer
                            </h2>
                        </div>
                        <div class="widget-content">
                            <div class="timer-preview">
                                <div class="circular-progress">
                                    <svg>
                                        <circle class="circular-bg" cx="40" cy="40" r="36"></circle>
                                        <circle class="circular-fill" cx="40" cy="40" r="36"></circle>
                                    </svg>
                                    <div class="circular-text">
                                        <div id="timer-preview-display">25:00</div>
                                    </div>
                                </div>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button class="btn btn-primary" id="start-timer-from-dashboard">
                                        <i class="fas fa-play"></i> Start Focus
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Widget -->
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-chart-line"></i>
                                Weekly Progress
                            </h2>
                        </div>
                        <div class="widget-content">
                            <div class="progress-container">
                                <div class="progress-label">
                                    <span>XP Progress</span>
                                    <span id="xp-progress-text">0/500</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="xp-progress-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <canvas id="weeklyChart" height="120"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Smart Reminders -->
                <div class="widget">
                    <div class="widget-header">
                        <h2 class="widget-title">
                            <i class="fas fa-bell"></i>
                            Smart Reminders
                        </h2>
                    </div>
                    <div class="widget-content">
                        <div class="notification-list" id="smart-reminders">
                            <!-- Smart reminders will be populated here -->
                            <div class="empty-state">Complete tasks and study sessions to get personalized reminders!</div>
                        </div>
                    </div>
                </div>
                
                <!-- Notifications -->
                <div class="widget">
                    <div class="widget-header">
                        <h2 class="widget-title">
                            <i class="fas fa-bell"></i>
                            Notifications
                        </h2>
                    </div>
                    <div class="widget-content">
                        <div class="notification-list" id="notification-list">
                            <!-- Notifications will be populated here -->
                            <div class="empty-state">No notifications yet. Complete tasks to earn achievements!</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Timetable Section -->
            <section id="timetable" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-calendar-alt"></i>
                        Weekly Timetable
                    </h1>
                    <button class="btn btn-primary" id="add-class-btn">
                        <i class="fas fa-plus"></i> Add Class
                    </button>
                </div>
                
                <div class="widget">
                    <div class="widget-content">
                        <div class="timetable" id="timetable-grid">
                            <!-- Timetable will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Tasks Section -->
            <section id="tasks" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-tasks"></i>
                        Task Manager
                    </h1>
                    <div>
                        <button class="btn btn-primary" id="add-task-btn">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                        <button class="btn btn-secondary" id="auto-delete-completed-btn">
                            <i class="fas fa-trash"></i> Auto-Delete Completed
                        </button>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-content">
                        <ul class="task-list" id="task-list">
                            <!-- Tasks will be populated by JavaScript -->
                            <li class="empty-state">No tasks yet. Add your first task to get started!</li>
                        </ul>
                    </div>
                </div>
            </section>
            
            <!-- Notes Section -->
            <section id="notes" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-sticky-note"></i>
                        Notes
                    </h1>
                    <button class="btn btn-primary" id="add-note-btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </div>
                
                <div class="dashboard-grid">
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-list"></i>
                                My Notes
                            </h2>
                        </div>
                        <div class="widget-content">
                            <div class="notes-list" id="notes-list">
                                <!-- Notes will be populated by JavaScript -->
                                <div class="empty-state">No notes yet. Create your first note!</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-edit"></i>
                                Note Editor
                            </h2>
                        </div>
                        <div class="widget-content">
                            <!-- Quick Note Templates -->
                            <div class="quick-templates">
                                <button class="template-btn" data-template="lecture">Lecture Notes</button>
                                <button class="template-btn" data-template="book">Book Summary</button>
                                <button class="template-btn" data-template="meeting">Meeting Notes</button>
                                <button class="template-btn" data-template="code">Code Snippet</button>
                            </div>
                            
                            <!-- Session Quick Resume -->
                            <div class="session-resume" id="session-resume" style="display: none;">
                                <h3><i class="fas fa-history"></i> Continue Previous Session</h3>
                                <p id="resume-session-info">You have an unfinished session from earlier.</p>
                                <button class="btn btn-primary" id="resume-session-btn">
                                    <i class="fas fa-play"></i> Resume Session
                                </button>
                            </div>
                            
                            <div class="notes-view-mode">
                                <button class="view-mode-btn active" id="edit-mode-btn">
                                    <i class="fas fa-edit"></i> Edit Mode
                                </button>
                                <button class="view-mode-btn" id="view-mode-btn">
                                    <i class="fas fa-eye"></i> View Mode
                                </button>
                                <button class="view-mode-btn" id="mind-map-mode-btn">
                                    <i class="fas fa-project-diagram"></i> Mind Map
                                </button>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="note-title" placeholder="Note Title">
                            </div>
                            <div id="editor"></div>
                            <div id="notes-readonly" class="notes-readonly" style="display: none;"></div>
                            <div id="mind-map-container" class="mind-map-container" style="display: none;"></div>
                            <div class="note-sharing-options">
                                <button class="btn btn-secondary" id="copy-note-btn">
                                    <i class="fas fa-copy"></i> Copy Note
                                </button>
                                <button class="btn btn-secondary" id="summarize-note-btn">
                                    <i class="fas fa-file-alt"></i> Summarize
                                </button>
                            </div>
                            <div class="form-group" style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" id="save-note-btn">
                                    <i class="fas fa-save"></i> Save Note
                                </button>
                                <button class="btn btn-secondary" id="new-note-btn">
                                    <i class="fas fa-file"></i> New Note
                                </button>
                                <button class="btn btn-secondary" id="export-note-btn">
                                    <i class="fas fa-file-pdf"></i> Export as PDF
                                </button>
                                <button class="btn btn-secondary" id="delete-note-btn">
                                    <i class="fas fa-trash"></i> Delete Note
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Calendar Section -->
            <section id="calendar" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-calendar"></i>
                        Calendar
                    </h1>
                    <button class="btn btn-primary" id="add-event-btn">
                        <i class="fas fa-plus"></i> Add Event
                    </button>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h2 class="widget-title">
                            <i class="fas fa-calendar"></i>
                            October 2023
                        </h2>
                        <div>
                            <button class="btn btn-secondary" id="prev-month">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-secondary" id="next-month">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="widget-content">
                        <div class="calendar" id="calendar-grid">
                            <!-- Calendar will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Timer Section -->
            <section id="timer" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-clock"></i>
                        Pomodoro Timer
                    </h1>
                </div>
                
                <div class="widget">
                    <div class="widget-content">
                        <!-- Seasonal Theme Indicator -->
                        <div class="seasonal-theme" id="seasonal-theme" style="display: none;">
                            <div id="seasonal-icon"></div>
                            <div id="seasonal-message">Halloween Theme Active! Spooky studying!</div>
                        </div>
                        
                        <!-- Quick Mood Check-in -->
                        <div class="mood-checkin">
                            <div class="mood-btn" data-mood="happy"></div>
                            <div class="mood-btn" data-mood="neutral"></div>
                            <div class="mood-btn" data-mood="sad"></div>
                            <div class="mood-btn" data-mood="tired"></div>
                            <div class="mood-btn" data-mood="focused"></div>
                        </div>
                        
                        <!-- Quick Session Templates -->
                        <div class="session-templates">
                            <div class="session-template" data-template="last">
                                <h3><i class="fas fa-history"></i> Last Session</h3>
                                <p>Resume your previous study setup</p>
                            </div>
                            <div class="session-template" data-template="energy">
                                <h3><i class="fas fa-bolt"></i> Energy Boost</h3>
                                <p>Short, high-intensity focus bursts</p>
                            </div>
                            <div class="session-template" data-template="deep">
                                <h3><i class="fas fa-brain"></i> Deep Work</h3>
                                <p>Extended focus with longer breaks</p>
                            </div>
                        </div>
                        
                        <!-- Study Session Naming -->
                        <div class="session-naming">
                            <div class="session-name" id="session-name-1">Quantum Quest</div>
                            <div class="session-name" id="session-name-2">Code Crusade</div>
                            <div class="session-name" id="session-name-3">History Hunt</div>
                            <button class="btn btn-secondary" id="generate-session-name">
                                <i class="fas fa-random"></i> New Name
                            </button>
                        </div>
                        
                        <div class="timer-container">
                            <div class="timer-display" id="timer-display">25:00</div>
                            <div class="timer-controls">
                                <button class="timer-btn start" id="start-timer">
                                    <i class="fas fa-play"></i> Start
                                </button>
                                <button class="timer-btn pause" id="pause-timer">
                                    <i class="fas fa-pause"></i> Pause
                                </button>
                                <button class="timer-btn reset" id="reset-timer">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                            <div class="timer-mode">
                                <button class="mode-btn active" data-minutes="25">Focus (25m)</button>
                                <button class="mode-btn" data-minutes="5">Short Break (5m)</button>
                                <button class="mode-btn" data-minutes="15">Long Break (15m)</button>
                            </div>
                            <div class="timer-extras">
                                <button class="btn btn-secondary" id="skip-break-btn">
                                    <i class="fas fa-forward"></i> Skip Break
                                </button>
                                <button class="btn btn-secondary" id="extend-session-btn">
                                    <i class="fas fa-plus-circle"></i> Extend 15min
                                </button>
                            </div>
                            <div class="progress-container" style="margin-top: 30px;">
                                <div class="progress-label">
                                    <span>Sessions Completed Today</span>
                                    <span id="sessions-count">0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="sessions-progress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Study Quests -->
                <div class="widget">
                    <div class="widget-header">
                        <h2 class="widget-title">
                            <i class="fas fa-quest"></i>
                            Study Quests
                        </h2>
                    </div>
                    <div class="widget-content">
                        <div class="study-quests">
                            <div class="quest-card" data-quest="researcher">
                                <div class="quest-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <h3>Researcher</h3>
                                <p>Gather information and analyze data</p>
                                <div class="quest-ability">Ability: +25% XP from notes</div>
                            </div>
                            <div class="quest-card" data-quest="analyst">
                                <div class="quest-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <h3>Analyst</h3>
                                <p>Break down complex problems</p>
                                <div class="quest-ability">Ability: Unlock advanced insights</div>
                            </div>
                            <div class="quest-card" data-quest="creator">
                                <div class="quest-icon">
                                    <i class="fas fa-paint-brush"></i>
                                </div>
                                <h3>Creator</h3>
                                <p>Build and design new solutions</p>
                                <div class="quest-ability">Ability: Enhanced whiteboard tools</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" id="select-quest-btn">
                                <i class="fas fa-check"></i> Select Quest
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Subjects Section -->
            <section id="subjects" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-book"></i>
                        Subjects
                    </h1>
                    <button class="btn btn-primary" id="add-subject-btn">
                        <i class="fas fa-plus"></i> Add Subject
                    </button>
                </div>
                
                <div class="dashboard-grid" id="subjects-grid">
                    <!-- Subjects will be populated by JavaScript -->
                    <div class="empty-state">No subjects added yet. Add your first subject!</div>
                </div>
            </section>
            
            <!-- Resources Section -->
            <section id="resources" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-link"></i>
                        Resource Manager
                    </h1>
                    <button class="btn btn-primary" id="add-resource-btn">
                        <i class="fas fa-plus"></i> Add Resource
                    </button>
                </div>
                
                <div class="widget">
                    <div class="widget-content">
                        <div id="resources-container">
                            <!-- Resources will be populated by JavaScript -->
                            <div class="empty-state">No resources added yet. Add your first resource!</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Progress Section -->
            <section id="progress" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-chart-line"></i>
                        Progress Tracking
                    </h1>
                </div>
                
                <div class="dashboard-grid">
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-chart-bar"></i>
                                Study Time by Subject
                            </h2>
                        </div>
                        <div class="widget-content">
                            <canvas id="subjectChart" height="250"></canvas>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-chart-line"></i>
                                Weekly Study Trend
                            </h2>
                        </div>
                        <div class="widget-content">
                            <canvas id="weeklyTrendChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Study Time Predictions -->
                <div class="widget">
                    <div class="widget-header">
                        <h2 class="widget-title">
                            <i class="fas fa-hourglass-half"></i>
                            Study Time Predictions
                        </h2>
                    </div>
                    <div class="widget-content">
                        <div id="study-predictions">
                            <!-- Predictions will be populated here -->
                            <div class="empty-state">Complete more study sessions to get personalized predictions!</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Achievements Section -->
            <section id="achievements" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-trophy"></i>
                        Achievements
                    </h1>
                </div>
                
                <div class="widget">
                    <div class="widget-content">
                        <div class="achievements-grid" id="achievements-grid">
                            <!-- Achievements will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Backup & Restore Section -->
            <section id="backup" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-download"></i>
                        Backup & Restore
                    </h1>
                </div>
                
                <div class="dashboard-grid">
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-download"></i>
                                Backup Data
                            </h2>
                        </div>
                        <div class="widget-content">
                            <p>Create a backup of all your StudyQuest data. This will download a JSON file that you can use to restore your data later.</p>
                            <div class="backup-actions">
                                <button class="btn btn-primary" id="backup-data-btn">
                                    <i class="fas fa-file-export"></i> Export Backup
                                </button>
                                <button class="btn btn-secondary" id="copy-data-btn">
                                    <i class="fas fa-copy"></i> Copy Data
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-upload"></i>
                                Restore Data
                            </h2>
                        </div>
                        <div class="widget-content">
                            <p>Restore your StudyQuest data from a previously created backup file.</p>
                            <div class="form-group">
                                <label class="form-label" for="restore-file">Select Backup File</label>
                                <input type="file" class="form-control" id="restore-file" accept=".json">
                            </div>
                            <div class="backup-actions">
                                <button class="btn btn-primary" id="restore-data-btn">
                                    <i class="fas fa-file-import"></i> Restore Backup
                                </button>
                            </div>
                            <div class="alert alert-warning" style="margin-top: 15px; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                                <strong>Warning:</strong> Restoring data will overwrite all your current data. This action cannot be undone.
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Settings Section -->
            <section id="settings" class="section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-cog"></i>
                        Settings
                    </h1>
                </div>
                
                <div class="dashboard-grid">
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-user"></i>
                                Profile Settings
                            </h2>
                        </div>
                        <div class="widget-content">
                            <div class="form-group">
                                <label class="form-label" for="settings-username">Username</label>
                                <input type="text" class="form-control" id="settings-username" placeholder="Enter your username">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="study-space-name">Study Space Name</label>
                                <input type="text" class="form-control" id="study-space-name" placeholder="e.g., Sarah's Study Cave">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" id="save-profile-btn">
                                    <i class="fas fa-save"></i> Save Profile
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-palette"></i>
                                Theme Settings
                            </h2>
                        </div>
                        <div class="widget-content">
                            <p>Choose your preferred theme for StudyQuest:</p>
                            <div class="theme-toggle">
                                <div class="theme-option active" data-theme="dark">
                                    <div class="theme-preview dark"></div>
                                    <span>Dark Theme</span>
                                </div>
                                <div class="theme-option" data-theme="light">
                                    <div class="theme-preview light"></div>
                                    <span>Light Theme</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-smile"></i>
                                Personalization
                            </h2>
                        </div>
                        <div class="widget-content">
                            <p>Choose your focus emoji/mascot:</p>
                            <div class="personalization-options" id="focus-emojis">
                                <div class="personalization-option active" data-emoji="">
                                    <div class="personalization-icon"></div>
                                    <div class="personalization-name">Dragon</div>
                                    <div class="personalization-desc">Powerful & focused</div>
                                </div>
                                <div class="personalization-option" data-emoji="">
                                    <div class="personalization-icon"></div>
                                    <div class="personalization-name">Owl</div>
                                    <div class="personalization-desc">Wise & attentive</div>
                                </div>
                                <div class="personalization-option" data-emoji="">
                                    <div class="personalization-icon"></div>
                                    <div class="personalization-name">Rocket</div>
                                    <div class="personalization-desc">Fast & efficient</div>
                                </div>
                                <div class="personalization-option" data-emoji="">
                                    <div class="personalization-icon"></div>
                                    <div class="personalization-name">Brain</div>
                                    <div class="personalization-desc">Smart & analytical</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <p>Custom study session names:</p>
                                <div class="form-group">
                                    <input type="text" class="form-control" id="session-name-1" placeholder="e.g., Crunch Time" value="Crunch Time">
                                </div>
                                <div class="form-group">
                                    <input type="text" class="form-control" id="session-name-2" placeholder="e.g., Deep Work" value="Deep Work">
                                </div>
                                <div class="form-group">
                                    <input type="text" class="form-control" id="session-name-3" placeholder="e.g., Focus Burst" value="Focus Burst">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Environment Settings -->
                    <div class="widget">
                        <div class="widget-header">
                            <h2 class="widget-title">
                                <i class="fas fa-cloud"></i>
                                Study Environment
                            </h2>
                        </div>
                        <div class="widget-content">
                            <p>Choose your preferred study environment:</p>
                            <div class="environment-selector" id="environment-selector">
                                <div class="environment-option active" data-environment="clear">
                                    <div class="environment-icon"></div>
                                    <div class="environment-name">Clear Day</div>
                                    <div class="environment-desc">Bright and focused</div>
                                </div>
                                <div class="environment-option" data-environment="night">
                                    <div class="environment-icon"></div>
                                    <div class="environment-name">Night</div>
                                    <div class="environment-desc">Calm and peaceful</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Class Modal -->
    <div class="modal" id="class-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="class-modal-title">Add Class</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="class-form">
                <input type="hidden" id="edit-class-id">
                <div class="form-group">
                    <label class="form-label" for="class-subject">Subject</label>
                    <input type="text" class="form-control" id="class-subject" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="class-topic">Topic</label>
                    <input type="text" class="form-control" id="class-topic">
                </div>
                <div class="form-group">
                    <label class="form-label" for="class-color">Color</label>
                    <input type="color" class="form-control" id="class-color" value="#e94560">
                </div>
                <div class="form-group">
                    <label class="form-label" for="class-day">Day</label>
                    <select class="form-control" id="class-day" required>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                        <option value="7">Sunday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="class-time">Time</label>
                    <select class="form-control" id="class-time" required>
                        <option value="8">8:00 AM</option>
                        <option value="9">9:00 AM</option>
                        <option value="10">10:00 AM</option>
                        <option value="11">11:00 AM</option>
                        <option value="12">12:00 PM</option>
                        <option value="13">1:00 PM</option>
                        <option value="14">2:00 PM</option>
                        <option value="15">3:00 PM</option>
                        <option value="16">4:00 PM</option>
                        <option value="17">5:00 PM</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="save-class-btn">Save Class</button>
                    <button type="button" class="btn btn-secondary" id="delete-class-btn" style="flex: 1;">Delete Class</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="task-modal-title">Add Task</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="task-form">
                <input type="hidden" id="edit-task-id">
                <div class="form-group">
                    <label class="form-label" for="task-title">Title</label>
                    <input type="text" class="form-control" id="task-title" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="task-description">Description</label>
                    <textarea class="form-control" id="task-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="task-due">Due Date</label>
                    <input type="date" class="form-control" id="task-due" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="task-subject">Subject (Optional)</label>
                    <select class="form-control" id="task-subject">
                        <option value="">No Subject</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;" id="save-task-btn">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="event-modal-title">Add Event</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="event-form">
                <input type="hidden" id="edit-event-id">
                <div class="form-group">
                    <label class="form-label" for="event-title">Title</label>
                    <input type="text" class="form-control" id="event-title" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="event-description">Description</label>
                    <textarea class="form-control" id="event-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="event-date">Date</label>
                    <input type="date" class="form-control" id="event-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="event-time">Time</label>
                    <input type="time" class="form-control" id="event-time">
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="save-event-btn">Save Event</button>
                    <button type="button" class="btn btn-secondary" id="delete-event-btn" style="flex: 1;">Delete Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subject Modal -->
    <div class="modal" id="subject-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="subject-modal-title">Add Subject</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="subject-form">
                <input type="hidden" id="edit-subject-id">
                <div class="form-group">
                    <label class="form-label" for="subject-name">Subject Name</label>
                    <input type="text" class="form-control" id="subject-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="subject-color">Color</label>
                    <input type="color" class="form-control" id="subject-color" value="#e94560">
                </div>
                <div class="form-group">
                    <label class="form-label" for="subject-resources">Resources (one per line)</label>
                    <textarea class="form-control" id="subject-resources" rows="5" placeholder="Add links to resources like YouTube videos, PDFs, websites..."></textarea>
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="save-subject-btn">Save Subject</button>
                    <button type="button" class="btn btn-secondary" id="delete-subject-btn" style="flex: 1;">Delete Subject</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Resource Modal -->
    <div class="modal" id="resource-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="resource-modal-title">Add Resource</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="resource-form">
                <input type="hidden" id="edit-resource-id">
                <div class="form-group">
                    <label class="form-label" for="resource-name">Resource Name</label>
                    <input type="text" class="form-control" id="resource-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="resource-url">URL</label>
                    <input type="url" class="form-control" id="resource-url" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="resource-description">Description</label>
                    <textarea class="form-control" id="resource-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="resource-category">Category</label>
                    <select class="form-control" id="resource-category" required>
                        <option value="pdf">PDF Document</option>
                        <option value="video">Video</option>
                        <option value="website">Website</option>
                        <option value="book">Book</option>
                        <option value="article">Article</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="save-resource-btn">Save Resource</button>
                    <button type="button" class="btn btn-secondary" id="delete-resource-btn" style="flex: 1;">Delete Resource</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Application State
        let state = {
            xp: 0,
            streak: 0,
            level: 1,
            tasks: [],
            classes: [],
            notes: [],
            events: [],
            subjects: [],
            resources: [],
            achievements: [
                { id: 1, name: "First Step", description: "Complete your first task", icon: "fa-flag", unlocked: false, progress: 0, target: 1 },
                { id: 2, name: "Marathon Runner", description: "Complete 5 Pomodoro sessions in one day", icon: "fa-running", unlocked: false, progress: 0, target: 5 },
                { id: 3, name: "Consistency is Key", description: "Maintain a 7-day study streak", icon: "fa-calendar-check", unlocked: false, progress: 0, target: 7 },
                { id: 4, name: "Subject Master", description: "Log 10 study sessions for a single subject", icon: "fa-graduation-cap", unlocked: false, progress: 0, target: 10 },
                { id: 5, name: "Task Crusher", description: "Complete 20 total tasks", icon: "fa-tasks", unlocked: false, progress: 0, target: 20 },
                { id: 6, name: "Early Bird", description: "Start a study session before 8 AM", icon: "fa-sun", unlocked: false, progress: 0, target: 1 },
                { id: 7, name: "Weekend Warrior", description: "Log a study session on a weekend", icon: "fa-calendar-week", unlocked: false, progress: 0, target: 1 },
                { id: 8, name: "Perfect Week", description: "Fulfill every planned timetable slot for a week", icon: "fa-trophy", unlocked: false, progress: 0, target: 1 }
            ],
            timerSessions: 0,
            lastStudyDate: null,
            studySessions: {},
            currentNoteId: null,
            currentEditingClass: null,
            currentEditingTask: null,
            currentEditingEvent: null,
            currentEditingSubject: null,
            currentEditingResource: null,
            username: "John Student",
            studySpaceName: "My Study Space",
            focusEmoji: "",
            sessionNames: ["Crunch Time", "Deep Work", "Focus Burst"],
            theme: "dark",
            lastActivityDate: null,
            studyPredictions: {},
            surpriseRewards: [],
            notesViewMode: "edit", // 'edit' or 'view'
            // New state properties for enhanced features
            emojiPowerUps: {
                dragon: { active: false, endTime: null, xpMultiplier: 2 },
                owl: { active: false, endTime: null, reducedNotifications: true },
                rocket: { active: false, endTime: null, taskBonus: 1.5 },
                brain: { active: false, endTime: null, betterPredictions: true }
            },
            emojiLevel: 1,
            environment: "clear",
            mindMaps: [],
            currentMindMap: null,
            // New state for additional features
            quickTemplates: {
                lecture: "<h2>Lecture Notes</h2><h3>Topic:</h3><p>Main points:</p><ul><li>Key concept 1</li><li>Key concept 2</li><li>Key concept 3</li></ul><h3>Summary:</h3><p>Overall understanding:</p>",
                book: "<h2>Book Summary</h2><h3>Title:</h3><p>Author:</p><h3>Key Takeaways:</h3><ul><li>Important point 1</li><li>Important point 2</li><li>Important point 3</li></ul><h3>Quotes:</h3><blockquote>Memorable quote</blockquote>",
                meeting: "<h2>Meeting Notes</h2><h3>Date:</h3><p>Attendees:</p><h3>Agenda:</h3><ol><li>Topic 1</li><li>Topic 2</li><li>Topic 3</li></ol><h3>Action Items:</h3><ul><li>Task 1 - Owner - Due Date</li><li>Task 2 - Owner - Due Date</li></ul>",
                code: "<h2>Code Documentation</h2><h3>Function:</h3><div class='code-block'><div class='code-header'>JavaScript <button class='copy-code-btn'>Copy</button></div><div class='code-content'><pre><code class='language-javascript'>// Your code here\nfunction example() {\n  return \"Hello, World!\";\n}</code></pre></div></div><h3>Explanation:</h3><p>What this code does:</p>"
            },
            currentMood: null,
            seasonalTheme: null,
            activeQuest: null,
            sessionHistory: [],
            // Timer state for session resume
            lastTimerState: {
                minutes: 25,
                seconds: 0,
                mode: 'focus',
                running: false
            }
        };

        // DOM Elements
        const sections = document.querySelectorAll('.section');
        const navLinks = document.querySelectorAll('.nav-link');
        const viewAllLinks = document.querySelectorAll('.view-all');
        const classModal = document.getElementById('class-modal');
        const taskModal = document.getElementById('task-modal');
        const eventModal = document.getElementById('event-modal');
        const subjectModal = document.getElementById('subject-modal');
        const resourceModal = document.getElementById('resource-modal');
        const classForm = document.getElementById('class-form');
        const taskForm = document.getElementById('task-form');
        const eventForm = document.getElementById('event-form');
        const subjectForm = document.getElementById('subject-form');
        const resourceForm = document.getElementById('resource-form');
        const addClassBtn = document.getElementById('add-class-btn');
        const addTaskBtn = document.getElementById('add-task-btn');
        const addEventBtn = document.getElementById('add-event-btn');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const addResourceBtn = document.getElementById('add-resource-btn');
        const addNoteBtn = document.getElementById('add-note-btn');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const taskList = document.getElementById('task-list');
        const dashboardTasks = document.getElementById('dashboard-tasks');
        const notesList = document.getElementById('notes-list');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const newNoteBtn = document.getElementById('new-note-btn');
        const exportNoteBtn = document.getElementById('export-note-btn');
        const deleteNoteBtn = document.getElementById('delete-note-btn');
        const noteTitle = document.getElementById('note-title');
        const startTimerBtn = document.getElementById('start-timer');
        const pauseTimerBtn = document.getElementById('pause-timer');
        const resetTimerBtn = document.getElementById('reset-timer');
        const skipBreakBtn = document.getElementById('skip-break-btn');
        const extendSessionBtn = document.getElementById('extend-session-btn');
        const timerDisplay = document.getElementById('timer-display');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const startTimerFromDashboard = document.getElementById('start-timer-from-dashboard');
        const timerPreviewDisplay = document.getElementById('timer-preview-display');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const xpCount = document.getElementById('xp-count');
        const streakCount = document.getElementById('streak-count');
        const levelCount = document.getElementById('level-count');
        const userLevel = document.getElementById('user-level');
        const xpProgressText = document.getElementById('xp-progress-text');
        const xpProgressBar = document.getElementById('xp-progress-bar');
        const sessionsCount = document.getElementById('sessions-count');
        const sessionsProgress = document.getElementById('sessions-progress');
        const todaySchedule = document.getElementById('today-schedule');
        const notificationList = document.getElementById('notification-list');
        const smartReminders = document.getElementById('smart-reminders');
        const timetableGrid = document.getElementById('timetable-grid');
        const calendarGrid = document.getElementById('calendar-grid');
        const subjectsGrid = document.getElementById('subjects-grid');
        const resourcesContainer = document.getElementById('resources-container');
        const achievementsGrid = document.getElementById('achievements-grid');
        const studyPredictions = document.getElementById('study-predictions');
        const taskSubjectSelect = document.getElementById('task-subject');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const backupDataBtn = document.getElementById('backup-data-btn');
        const restoreDataBtn = document.getElementById('restore-data-btn');
        const restoreFileInput = document.getElementById('restore-file');
        const settingsUsername = document.getElementById('settings-username');
        const studySpaceName = document.getElementById('study-space-name');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const themeOptions = document.querySelectorAll('.theme-option');
        const focusEmojis = document.querySelectorAll('.personalization-option');
        const sessionName1 = document.getElementById('session-name-1');
        const sessionName2 = document.getElementById('session-name-2');
        const sessionName3 = document.getElementById('session-name-3');
        const deleteEventBtn = document.getElementById('delete-event-btn');
        const editModeBtn = document.getElementById('edit-mode-btn');
        const viewModeBtn = document.getElementById('view-mode-btn');
        const notesReadonly = document.getElementById('notes-readonly');
        const copyDataBtn = document.getElementById('copy-data-btn');
        const autoDeleteCompletedBtn = document.getElementById('auto-delete-completed-btn');
        
        // New DOM Elements for Enhanced Features
        const focusEmoji = document.getElementById('focus-emoji');
        const emojiMessage = document.getElementById('emoji-message');
        const emojiPowerUpIndicator = document.getElementById('emoji-power-up-indicator');
        const emojiEvolution = document.getElementById('emoji-evolution');
        const environmentEffects = document.getElementById('environment-effects');
        const environmentSelector = document.getElementById('environment-selector');
        const environmentOptions = document.querySelectorAll('.environment-option');
        const mindMapModeBtn = document.getElementById('mind-map-mode-btn');
        const mindMapContainer = document.getElementById('mind-map-container');
        const copyNoteBtn = document.getElementById('copy-note-btn');
        const summarizeNoteBtn = document.getElementById('summarize-note-btn');
        
        // New DOM Elements for Additional Features
        const templateButtons = document.querySelectorAll('.template-btn');
        const sessionResume = document.getElementById('session-resume');
        const resumeSessionBtn = document.getElementById('resume-session-btn');
        const moodButtons = document.querySelectorAll('.mood-btn');
        const seasonalThemeIndicator = document.getElementById('seasonal-theme');
        const sessionTemplates = document.querySelectorAll('.session-template');
        const sessionNameElements = document.querySelectorAll('.session-name');
        const generateSessionNameBtn = document.getElementById('generate-session-name');
        const questCards = document.querySelectorAll('.quest-card');
        const selectQuestBtn = document.getElementById('select-quest-btn');

        // Quill Editor
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Start typing your note here...'
        });

        // Timer Variables
        let timerInterval;
        let timerMinutes = 25;
        let timerSeconds = 0;
        let timerRunning = false;
        let timerMode = 'focus'; // focus, shortBreak, longBreak
        let extendedSession = false;

        // Calendar Variables
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Initialize the application
        function init() {
            loadState();
            setupEventListeners();
            renderAll();
            updateStats();
            setupCharts();
            applyTheme();
            updateSmartReminders();
            updateStudyPredictions();
            
            // Initialize enhanced features
            setupFocusEmoji();
            setupEnvironment();
            setupMindMap();
            
            // Initialize new features
            setupQuickTemplates();
            setupSessionResume();
            setupMoodCheckin();
            setupSeasonalThemes();
            setupSessionTemplates();
            setupSessionNaming();
            setupStudyQuests();
            
            // Check if user studied today for streak
            checkStreak();
            
            // Set up interval for smart reminders
            setInterval(updateSmartReminders, 60000); // Update every minute
            setInterval(checkSurpriseRewards, 30000); // Check for surprise rewards every 30 seconds
            setInterval(checkPowerUps, 1000); // Check power-up status every second
        }

        // Load state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('studyQuestState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                state = { ...state, ...parsedState };
                
                // Update username in settings if it exists
                if (state.username) {
                    settingsUsername.value = state.username;
                    document.getElementById('user-name').textContent = state.username;
                    document.getElementById('user-avatar').textContent = state.username.substring(0, 2).toUpperCase();
                }
                
                // Update study space name
                if (state.studySpaceName) {
                    studySpaceName.value = state.studySpaceName;
                }
                
                // Update focus emoji
                if (state.focusEmoji) {
                    focusEmojis.forEach(emoji => {
                        if (emoji.getAttribute('data-emoji') === state.focusEmoji) {
                            emoji.classList.add('active');
                        } else {
                            emoji.classList.remove('active');
                        }
                    });
                    focusEmoji.textContent = state.focusEmoji;
                }
                
                // Update session names
                if (state.sessionNames && state.sessionNames.length >= 3) {
                    sessionName1.value = state.sessionNames[0];
                    sessionName2.value = state.sessionNames[1];
                    sessionName3.value = state.sessionNames[2];
                }
                
                // Update notes view mode
                if (state.notesViewMode) {
                    setNotesViewMode(state.notesViewMode);
                }
                
                // Update environment
                if (state.environment) {
                    setEnvironment(state.environment);
                }
                
                // Update emoji level
                if (state.emojiLevel) {
                    updateEmojiLevel(state.emojiLevel);
                }
                
                // Update seasonal theme
                if (state.seasonalTheme) {
                    applySeasonalTheme(state.seasonalTheme);
                }
                
                // Update active quest
                if (state.activeQuest) {
                    questCards.forEach(card => {
                        if (card.getAttribute('data-quest') === state.activeQuest) {
                            card.classList.add('active');
                        }
                    });
                }
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('studyQuestState', JSON.stringify(state));
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetSection = link.getAttribute('data-section');
                    
                    // Update active nav link
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show target section
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById(targetSection).classList.add('active');
                    
                    // Close mobile menu if open
                    sidebar.classList.remove('active');
                });
            });

            // View All links
            viewAllLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetSection = link.getAttribute('data-section');
                    
                    // Update active nav link
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    document.querySelector(`[data-section="${targetSection}"]`).classList.add('active');
                    
                    // Show target section
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById(targetSection).classList.add('active');
                    
                    // Close mobile menu if open
                    sidebar.classList.remove('active');
                });
            });

            // Mobile menu toggle
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });

            // Modal buttons
            addClassBtn.addEventListener('click', () => {
                document.getElementById('class-modal-title').textContent = 'Add Class';
                document.getElementById('edit-class-id').value = '';
                document.getElementById('delete-class-btn').style.display = 'block';
                classModal.classList.add('active');
            });

            addTaskBtn.addEventListener('click', () => {
                document.getElementById('task-modal-title').textContent = 'Add Task';
                document.getElementById('edit-task-id').value = '';
                taskModal.classList.add('active');
            });

            addEventBtn.addEventListener('click', () => {
                document.getElementById('event-modal-title').textContent = 'Add Event';
                document.getElementById('edit-event-id').value = '';
                document.getElementById('delete-event-btn').style.display = 'block';
                eventModal.classList.add('active');
            });

            addSubjectBtn.addEventListener('click', () => {
                document.getElementById('subject-modal-title').textContent = 'Add Subject';
                document.getElementById('edit-subject-id').value = '';
                document.getElementById('delete-subject-btn').style.display = 'block';
                subjectModal.classList.add('active');
            });

            addResourceBtn.addEventListener('click', () => {
                document.getElementById('resource-modal-title').textContent = 'Add Resource';
                document.getElementById('edit-resource-id').value = '';
                document.getElementById('delete-resource-btn').style.display = 'block';
                resourceModal.classList.add('active');
            });

            addNoteBtn.addEventListener('click', () => {
                newNote();
            });

            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    classModal.classList.remove('active');
                    taskModal.classList.remove('active');
                    eventModal.classList.remove('active');
                    subjectModal.classList.remove('active');
                    resourceModal.classList.remove('active');
                });
            });

            // Form submissions
            classForm.addEventListener('submit', handleClassSubmit);
            taskForm.addEventListener('submit', handleTaskSubmit);
            eventForm.addEventListener('submit', handleEventSubmit);
            subjectForm.addEventListener('submit', handleSubjectSubmit);
            resourceForm.addEventListener('submit', handleResourceSubmit);

            // Timer controls
            startTimerBtn.addEventListener('click', startTimer);
            pauseTimerBtn.addEventListener('click', pauseTimer);
            resetTimerBtn.addEventListener('click', resetTimer);
            skipBreakBtn.addEventListener('click', skipBreak);
            extendSessionBtn.addEventListener('click', extendSession);
            startTimerFromDashboard.addEventListener('click', () => {
                // Navigate to timer and start it
                navLinks.forEach(nav => nav.classList.remove('active'));
                document.querySelector('[data-section="timer"]').classList.add('active');
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById('timer').classList.add('active');
                startTimer();
            });

            // Timer mode buttons
            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    modeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const minutes = parseInt(btn.getAttribute('data-minutes'));
                    timerMinutes = minutes;
                    timerSeconds = 0;
                    updateTimerDisplay();
                    
                    // Set timer mode
                    if (minutes === 25) timerMode = 'focus';
                    else if (minutes === 5) timerMode = 'shortBreak';
                    else if (minutes === 15) timerMode = 'longBreak';
                });
            });

            // Note controls
            saveNoteBtn.addEventListener('click', saveNote);
            newNoteBtn.addEventListener('click', newNote);
            exportNoteBtn.addEventListener('click', exportNoteAsPDF);
            deleteNoteBtn.addEventListener('click', deleteNote);

            // Notes view mode buttons
            editModeBtn.addEventListener('click', () => {
                setNotesViewMode('edit');
            });
            
            viewModeBtn.addEventListener('click', () => {
                setNotesViewMode('view');
            });
            
            // Mind map mode button
            mindMapModeBtn.addEventListener('click', () => {
                setNotesViewMode('mindmap');
            });

            // Calendar navigation
            prevMonthBtn.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });

            // Delete buttons in modals
            document.getElementById('delete-class-btn').addEventListener('click', deleteClass);
            document.getElementById('delete-subject-btn').addEventListener('click', deleteSubject);
            document.getElementById('delete-resource-btn').addEventListener('click', deleteResource);
            deleteEventBtn.addEventListener('click', deleteEvent);

            // Backup and Restore
            backupDataBtn.addEventListener('click', backupData);
            restoreDataBtn.addEventListener('click', restoreData);
            copyDataBtn.addEventListener('click', copyDataToClipboard);

            // Settings
            saveProfileBtn.addEventListener('click', saveProfile);
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.getAttribute('data-theme');
                    setTheme(theme);
                });
            });

            // Personalization
            focusEmojis.forEach(emoji => {
                emoji.addEventListener('click', () => {
                    focusEmojis.forEach(e => e.classList.remove('active'));
                    emoji.classList.add('active');
                    state.focusEmoji = emoji.getAttribute('data-emoji');
                    focusEmoji.textContent = state.focusEmoji;
                    
                    // Activate power-up for selected emoji
                    activateEmojiPowerUp(state.focusEmoji);
                    
                    saveState();
                    showToast(`Focus emoji updated to ${state.focusEmoji}`);
                });
            });

            // Session names
            [sessionName1, sessionName2, sessionName3].forEach((input, index) => {
                input.addEventListener('change', () => {
                    state.sessionNames[index] = input.value;
                    saveState();
                });
            });

            // Auto-delete completed tasks
            autoDeleteCompletedBtn.addEventListener('click', autoDeleteCompletedTasks);
            
            // Enhanced feature event listeners
            setupEnhancedFeatureListeners();
            
            // New feature event listeners
            setupNewFeatureListeners();
        }

        // Setup enhanced feature event listeners
        function setupEnhancedFeatureListeners() {
            // Focus emoji interaction
            focusEmoji.addEventListener('click', handleEmojiClick);
            
            // Environment selector
            environmentOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const environment = option.getAttribute('data-environment');
                    setEnvironment(environment);
                });
            });
            
            // Note sharing
            copyNoteBtn.addEventListener('click', copyNoteToClipboard);
            summarizeNoteBtn.addEventListener('click', summarizeNote);
        }

        // Setup new feature event listeners
        function setupNewFeatureListeners() {
            // Quick templates
            templateButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const template = btn.getAttribute('data-template');
                    applyQuickTemplate(template);
                });
            });
            
            // Session resume
            resumeSessionBtn.addEventListener('click', resumeLastSession);
            
            // Mood check-in
            moodButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mood = btn.getAttribute('data-mood');
                    setMood(mood);
                });
            });
            
            // Session templates
            sessionTemplates.forEach(template => {
                template.addEventListener('click', () => {
                    const templateType = template.getAttribute('data-template');
                    applySessionTemplate(templateType);
                });
            });
            
            // Session naming
            generateSessionNameBtn.addEventListener('click', generateSessionName);
            sessionNameElements.forEach(name => {
                name.addEventListener('click', () => {
                    sessionNameElements.forEach(n => n.style.background = 'rgba(255, 255, 255, 0.1)');
                    name.style.background = 'rgba(233, 69, 96, 0.3)';
                });
            });
            
            // Study quests
            questCards.forEach(card => {
                card.addEventListener('click', () => {
                    questCards.forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                });
            });
            
            selectQuestBtn.addEventListener('click', selectQuest);
        }

        // New Feature Implementations

        // Quick Note Templates
        function setupQuickTemplates() {
            // Already set up in event listeners
        }

        function applyQuickTemplate(template) {
            if (state.quickTemplates[template]) {
                quill.root.innerHTML = state.quickTemplates[template];
                
                // If it's a code template, set up syntax highlighting
                if (template === 'code') {
                    setTimeout(() => {
                        document.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                        
                        // Add copy functionality to code blocks
                        document.querySelectorAll('.copy-code-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const codeContent = this.parentElement.nextElementSibling.textContent;
                                navigator.clipboard.writeText(codeContent).then(() => {
                                    showToast('Code copied to clipboard!');
                                });
                            });
                        });
                    }, 100);
                }
                
                showToast(`${template.charAt(0).toUpperCase() + template.slice(1)} template applied!`);
            }
        }

        // Session Quick Resume
        function setupSessionResume() {
            // Check if there's a recent session to resume
            if (state.lastTimerState) {
                const sessionTime = new Date();
                const now = new Date();
                const hoursSinceSession = (now - sessionTime) / (1000 * 60 * 60);
                
                // Show resume option if session was within the last 24 hours
                if (hoursSinceSession < 24) {
                    sessionResume.style.display = 'block';
                    document.getElementById('resume-session-info').textContent = 
                        `You have an unfinished ${state.lastTimerState.mode} session from earlier.`;
                }
            }
        }

        function resumeLastSession() {
            if (state.lastTimerState) {
                const lastSession = state.lastTimerState;
                
                // Apply session settings
                timerMinutes = lastSession.minutes;
                timerSeconds = lastSession.seconds;
                timerMode = lastSession.mode;
                
                // Set the correct mode button active
                modeButtons.forEach(btn => {
                    if (btn.getAttribute('data-minutes') === timerMinutes.toString()) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                updateTimerDisplay();
                
                showToast('Previous session resumed!');
                sessionResume.style.display = 'none';
            }
        }

        // Quick Mood Check-in
        function setupMoodCheckin() {
            // Already set up in event listeners
        }

        function setMood(mood) {
            state.currentMood = mood;
            
            // Update UI
            moodButtons.forEach(btn => {
                if (btn.getAttribute('data-mood') === mood) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Provide mood-based recommendations
            let recommendation = '';
            switch(mood) {
                case 'happy':
                    recommendation = 'Great! Use this positive energy for challenging tasks.';
                    break;
                case 'neutral':
                    recommendation = 'Good time for routine studying and review.';
                    break;
                case 'sad':
                    recommendation = 'Try starting with easier tasks to build momentum.';
                    break;
                case 'tired':
                    recommendation = 'Consider shorter sessions with more breaks.';
                    break;
                case 'focused':
                    recommendation = 'Perfect for deep work and complex topics.';
                    break;
            }
            
            showToast(`Mood set to ${mood}. ${recommendation}`);
            saveState();
        }

        // Seasonal Themes
        function setupSeasonalThemes() {
            const now = new Date();
            const month = now.getMonth() + 1; // 1-12
            const day = now.getDate();
            
            let theme = null;
            
            // Halloween (October)
            if (month === 10) {
                theme = 'halloween';
            }
            // Christmas (December)
            else if (month === 12 && day >= 15 && day <= 26) {
                theme = 'christmas';
            }
            // New Year (Late December - Early January)
            else if ((month === 12 && day >= 28) || (month === 1 && day <= 7)) {
                theme = 'newyear';
            }
            // Valentine's Day (February)
            else if (month === 2 && day >= 10 && day <= 16) {
                theme = 'valentines';
            }
            
            if (theme) {
                applySeasonalTheme(theme);
            }
        }

        function applySeasonalTheme(theme) {
            state.seasonalTheme = theme;
            
            let icon = '';
            let message = '';
            let achievementId = null;
            
            switch(theme) {
                case 'halloween':
                    icon = '';
                    message = 'Halloween Theme Active! Spooky studying!';
                    achievementId = 'seasonal_halloween';
                    break;
                case 'christmas':
                    icon = '';
                    message = 'Christmas Theme Active! Festive studying!';
                    achievementId = 'seasonal_christmas';
                    break;
                case 'newyear':
                    icon = '';
                    message = 'New Year Theme Active! Fresh start studying!';
                    achievementId = 'seasonal_newyear';
                    break;
                case 'valentines':
                    icon = '';
                    message = 'Valentine\'s Theme Active! Loving your studies!';
                    achievementId = 'seasonal_valentines';
                    break;
            }
            
            seasonalThemeIndicator.style.display = 'flex';
            document.getElementById('seasonal-icon').textContent = icon;
            document.getElementById('seasonal-message').textContent = message;
            
            // Award seasonal achievement if not already unlocked
            if (achievementId && !state.achievements.find(a => a.id === achievementId && a.unlocked)) {
                // This would require adding seasonal achievements to the state
                showToast(`Seasonal theme activated! ${message}`);
            }
            
            saveState();
        }

        // Quick Session Templates
        function setupSessionTemplates() {
            // Already set up in event listeners
        }

        function applySessionTemplate(templateType) {
            sessionTemplates.forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-template="${templateType}"]`).classList.add('active');
            
            switch(templateType) {
                case 'last':
                    // Resume last session settings
                    resumeLastSession();
                    break;
                case 'energy':
                    // Energy boost: shorter focus, shorter breaks
                    document.querySelector('[data-minutes="15"]').click();
                    showToast('Energy Boost template applied! Short, intense focus sessions.');
                    break;
                case 'deep':
                    // Deep work: longer focus, longer breaks
                    document.querySelector('[data-minutes="45"]').click();
                    showToast('Deep Work template applied! Extended focus sessions.');
                    break;
            }
        }

        // Study Session Naming
        function setupSessionNaming() {
            // Already set up in event listeners
        }

        function generateSessionName() {
            const themes = [
                { prefix: 'Quantum', suffix: ['Quest', 'Voyage', 'Expedition', 'Mission'] },
                { prefix: 'Code', suffix: ['Crusade', 'Adventure', 'Journey', 'Challenge'] },
                { prefix: 'History', suffix: ['Hunt', 'Exploration', 'Discovery', 'Investigation'] },
                { prefix: 'Math', suffix: ['Marathon', 'Puzzle', 'Problem', 'Equation'] },
                { prefix: 'Science', suffix: ['Experiment', 'Research', 'Study', 'Analysis'] },
                { prefix: 'Language', suffix: ['Immersion', 'Practice', 'Study', 'Session'] }
            ];
            
            const theme = themes[Math.floor(Math.random() * themes.length)];
            const suffix = theme.suffix[Math.floor(Math.random() * theme.suffix.length)];
            const name = `${theme.prefix} ${suffix}`;
            
            // Update one of the session name elements
            const randomIndex = Math.floor(Math.random() * sessionNameElements.length);
            sessionNameElements[randomIndex].textContent = name;
            sessionNameElements[randomIndex].style.background = 'rgba(233, 69, 96, 0.3)';
            
            showToast(`New session name: ${name}`);
        }

        // Study Quests
        function setupStudyQuests() {
            // Already set up in event listeners
        }

        function selectQuest() {
            const activeQuestCard = document.querySelector('.quest-card.active');
            if (activeQuestCard) {
                const quest = activeQuestCard.getAttribute('data-quest');
                state.activeQuest = quest;
                
                let ability = '';
                switch(quest) {
                    case 'researcher':
                        ability = '+25% XP from notes';
                        break;
                    case 'analyst':
                        ability = 'Unlock advanced insights';
                        break;
                    case 'creator':
                        ability = 'Enhanced whiteboard tools';
                        break;
                }
                
                showToast(`Quest selected: ${quest}! Ability: ${ability}`);
                saveState();
            } else {
                showToast('Please select a quest first', 'error');
            }
        }

        // Form submission handlers
        function handleClassSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-class-id').value;
            const subject = document.getElementById('class-subject').value;
            const topic = document.getElementById('class-topic').value;
            const color = document.getElementById('class-color').value;
            const day = parseInt(document.getElementById('class-day').value);
            const time = parseInt(document.getElementById('class-time').value);
            
            if (id) {
                // Update existing class
                const classIndex = state.classes.findIndex(c => c.id === id);
                if (classIndex !== -1) {
                    state.classes[classIndex] = { id, subject, topic, color, day, time };
                }
            } else {
                // Add new class
                const newClass = {
                    id: generateId(),
                    subject,
                    topic,
                    color,
                    day,
                    time
                };
                state.classes.push(newClass);
            }
            
            saveState();
            renderTimetable();
            renderTodaySchedule();
            classModal.classList.remove('active');
            classForm.reset();
            showToast('Class saved successfully!');
        }

        function handleTaskSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-task-id').value;
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const due = document.getElementById('task-due').value;
            const subject = document.getElementById('task-subject').value;
            
            if (id) {
                // Update existing task
                const taskIndex = state.tasks.findIndex(t => t.id === id);
                if (taskIndex !== -1) {
                    state.tasks[taskIndex] = { 
                        id, 
                        title, 
                        description, 
                        due, 
                        subject,
                        completed: state.tasks[taskIndex].completed 
                    };
                }
            } else {
                // Add new task
                const newTask = {
                    id: generateId(),
                    title,
                    description,
                    due,
                    subject,
                    completed: false
                };
                state.tasks.push(newTask);
            }
            
            saveState();
            renderTasks();
            taskModal.classList.remove('active');
            taskForm.reset();
            showToast('Task saved successfully!');
        }

        function handleEventSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-event-id').value;
            const title = document.getElementById('event-title').value;
            const description = document.getElementById('event-description').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            
            if (id) {
                // Update existing event
                const eventIndex = state.events.findIndex(e => e.id === id);
                if (eventIndex !== -1) {
                    state.events[eventIndex] = { id, title, description, date, time };
                }
            } else {
                // Add new event
                const newEvent = {
                    id: generateId(),
                    title,
                    description,
                    date,
                    time
                };
                state.events.push(newEvent);
            }
            
            saveState();
            renderCalendar();
            eventModal.classList.remove('active');
            eventForm.reset();
            showToast('Event saved successfully!');
        }

        function handleSubjectSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-subject-id').value;
            const name = document.getElementById('subject-name').value;
            const color = document.getElementById('subject-color').value;
            const resources = document.getElementById('subject-resources').value.split('\n').filter(r => r.trim() !== '');
            
            if (id) {
                // Update existing subject
                const subjectIndex = state.subjects.findIndex(s => s.id === id);
                if (subjectIndex !== -1) {
                    state.subjects[subjectIndex] = { id, name, color, resources };
                }
            } else {
                // Add new subject
                const newSubject = {
                    id: generateId(),
                    name,
                    color,
                    resources
                };
                state.subjects.push(newSubject);
            }
            
            saveState();
            renderSubjects();
            updateTaskSubjectSelect();
            subjectModal.classList.remove('active');
            subjectForm.reset();
            showToast('Subject saved successfully!');
        }

        function handleResourceSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-resource-id').value;
            const name = document.getElementById('resource-name').value;
            const url = document.getElementById('resource-url').value;
            const description = document.getElementById('resource-description').value;
            const category = document.getElementById('resource-category').value;
            
            if (id) {
                // Update existing resource
                const resourceIndex = state.resources.findIndex(r => r.id === id);
                if (resourceIndex !== -1) {
                    state.resources[resourceIndex] = { id, name, url, description, category };
                }
            } else {
                // Add new resource
                const newResource = {
                    id: generateId(),
                    name,
                    url,
                    description,
                    category
                };
                state.resources.push(newResource);
            }
            
            saveState();
            renderResources();
            resourceModal.classList.remove('active');
            resourceForm.reset();
            showToast('Resource saved successfully!');
        }

        // Delete functions
        function deleteClass() {
            const id = document.getElementById('edit-class-id').value;
            if (id) {
                state.classes = state.classes.filter(c => c.id !== id);
                saveState();
                renderTimetable();
                renderTodaySchedule();
                classModal.classList.remove('active');
                showToast('Class deleted successfully!');
            }
        }

        function deleteSubject() {
            const id = document.getElementById('edit-subject-id').value;
            if (id) {
                state.subjects = state.subjects.filter(s => s.id !== id);
                saveState();
                renderSubjects();
                updateTaskSubjectSelect();
                subjectModal.classList.remove('active');
                showToast('Subject deleted successfully!');
            }
        }

        function deleteResource() {
            const id = document.getElementById('edit-resource-id').value;
            if (id) {
                state.resources = state.resources.filter(r => r.id !== id);
                saveState();
                renderResources();
                resourceModal.classList.remove('active');
                showToast('Resource deleted successfully!');
            }
        }

        function deleteEvent() {
            const id = document.getElementById('edit-event-id').value;
            if (id) {
                state.events = state.events.filter(e => e.id !== id);
                saveState();
                renderCalendar();
                eventModal.classList.remove('active');
                showToast('Event deleted successfully!');
            }
        }

        // Note functions
        function saveNote() {
            const title = noteTitle.value.trim();
            const content = quill.root.innerHTML;
            
            if (!title) {
                showToast('Please enter a note title', 'error');
                return;
            }
            
            if (state.currentNoteId) {
                // Update existing note
                const noteIndex = state.notes.findIndex(n => n.id === state.currentNoteId);
                if (noteIndex !== -1) {
                    state.notes[noteIndex] = {
                        ...state.notes[noteIndex],
                        title,
                        content,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Create new note
                const newNote = {
                    id: generateId(),
                    title,
                    content,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                state.notes.push(newNote);
                state.currentNoteId = newNote.id;
            }
            
            saveState();
            renderNotes();
            showToast('Note saved successfully!');
            
            // Update read-only view if in view mode
            if (state.notesViewMode === 'view') {
                updateNotesReadonlyView();
            }
        }

        function newNote() {
            state.currentNoteId = null;
            noteTitle.value = '';
            quill.root.innerHTML = '';
            notesReadonly.innerHTML = '';
            
            // Update active note in list
            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        // Fixed PDF Export Function
        function exportNoteAsPDF() {
            if (!state.currentNoteId) {
                showToast('Please select or create a note first', 'error');
                return;
            }
            
            const note = state.notes.find(n => n.id === state.currentNoteId);
            if (!note) {
                showToast('Note not found', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Set up PDF styling
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            
            // Add header
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.text(note.title, margin, margin + 10);
            
            // Add date
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            const date = new Date(note.updatedAt).toLocaleDateString();
            pdf.text(`Last updated: ${date}`, margin, margin + 18);
            
            // Add content
            let yPosition = margin + 30;
            
            // Create a temporary div to parse the HTML content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = note.content;
            
            // Process each element in the content
            const elements = tempDiv.children;
            
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                const tagName = element.tagName.toLowerCase();
                
                // Check if we need a new page
                if (yPosition > pageHeight - margin) {
                    pdf.addPage();
                    yPosition = margin;
                }
                
                // Handle different element types
                if (tagName === 'h1' || tagName === 'h2' || tagName === 'h3') {
                    // Handle headers
                    const fontSize = tagName === 'h1' ? 16 : tagName === 'h2' ? 14 : 12;
                    pdf.setFontSize(fontSize);
                    pdf.setFont('helvetica', 'bold');
                    
                    const text = element.textContent;
                    const lines = pdf.splitTextToSize(text, contentWidth);
                    
                    lines.forEach(line => {
                        if (yPosition > pageHeight - margin) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        pdf.text(line, margin, yPosition);
                        yPosition += 8;
                    });
                    
                    yPosition += 5; // Extra space after header
                } 
                else if (tagName === 'p') {
                    // Handle paragraphs
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'normal');
                    
                    const text = element.textContent;
                    const lines = pdf.splitTextToSize(text, contentWidth);
                    
                    lines.forEach(line => {
                        if (yPosition > pageHeight - margin) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        pdf.text(line, margin, yPosition);
                        yPosition += 6;
                    });
                    
                    yPosition += 3; // Extra space after paragraph
                }
                else if (tagName === 'ul' || tagName === 'ol') {
                    // Handle lists
                    const listItems = element.querySelectorAll('li');
                    
                    listItems.forEach(item => {
                        if (yPosition > pageHeight - margin) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'normal');
                        
                        const bullet = tagName === 'ul' ? ' ' : (Array.from(listItems).indexOf(item) + 1) + '. ';
                        const text = bullet + item.textContent;
                        const lines = pdf.splitTextToSize(text, contentWidth - 5);
                        
                        lines.forEach((line, index) => {
                            if (yPosition > pageHeight - margin) {
                                pdf.addPage();
                                yPosition = margin;
                            }
                            
                            if (index === 0) {
                                pdf.text(line, margin, yPosition);
                            } else {
                                pdf.text(line, margin + 8, yPosition);
                            }
                            
                            yPosition += 6;
                        });
                    });
                    
                    yPosition += 3; // Extra space after list
                }
                else if (tagName === 'blockquote') {
                    // Handle blockquotes
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'italic');
                    
                    const text = element.textContent;
                    const lines = pdf.splitTextToSize(text, contentWidth - 10);
                    
                    // Draw a border for the blockquote
                    pdf.setDrawColor(200, 200, 200);
                    pdf.rect(margin, yPosition - 2, 3, lines.length * 6 + 4);
                    
                    lines.forEach(line => {
                        if (yPosition > pageHeight - margin) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        pdf.text(line, margin + 8, yPosition);
                        yPosition += 6;
                    });
                    
                    yPosition += 5; // Extra space after blockquote
                }
                else if (tagName === 'div' && element.classList.contains('code-block')) {
                    // Handle code blocks
                    const codeContent = element.querySelector('.code-content');
                    if (codeContent) {
                        const code = codeContent.textContent || codeContent.innerText;
                        
                        if (yPosition > pageHeight - margin - 20) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        
                        // Draw code block background
                        pdf.setFillColor(240, 240, 240);
                        pdf.rect(margin, yPosition - 3, contentWidth, 20, 'F');
                        
                        // Add code text
                        pdf.setFontSize(9);
                        pdf.setFont('courier', 'normal');
                        pdf.setTextColor(0, 0, 0);
                        
                        const codeLines = pdf.splitTextToSize(code, contentWidth - 10);
                        codeLines.forEach(line => {
                            if (yPosition > pageHeight - margin) {
                                pdf.addPage();
                                yPosition = margin;
                            }
                            pdf.text(line, margin + 5, yPosition);
                            yPosition += 4;
                        });
                        
                        yPosition += 5; // Extra space after code block
                    }
                }
                else {
                    // Handle any other elements as plain text
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'normal');
                    
                    const text = element.textContent;
                    const lines = pdf.splitTextToSize(text, contentWidth);
                    
                    lines.forEach(line => {
                        if (yPosition > pageHeight - margin) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        pdf.text(line, margin, yPosition);
                        yPosition += 6;
                    });
                    
                    yPosition += 3; // Extra space after element
                }
            }
            
            // Add page numbers
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(128, 128, 128);
                pdf.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 10);
            }
            
            // Save the PDF
            pdf.save(`${note.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
            showToast('PDF exported successfully!');
        }

        function deleteNote() {
            if (!state.currentNoteId) {
                showToast('Please select a note to delete', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this note?')) {
                state.notes = state.notes.filter(n => n.id !== state.currentNoteId);
                saveState();
                renderNotes();
                newNote();
                showToast('Note deleted successfully!');
            }
        }

        // Notes view mode functions
        function setNotesViewMode(mode) {
            state.notesViewMode = mode;
            saveState();
            
            // Reset all modes
            editModeBtn.classList.remove('active');
            viewModeBtn.classList.remove('active');
            mindMapModeBtn.classList.remove('active');
            document.getElementById('editor').style.display = 'none';
            notesReadonly.style.display = 'none';
            mindMapContainer.style.display = 'none';
            noteTitle.disabled = false;
            saveNoteBtn.disabled = false;
            
            if (mode === 'edit') {
                editModeBtn.classList.add('active');
                document.getElementById('editor').style.display = 'block';
            } else if (mode === 'view') {
                viewModeBtn.classList.add('active');
                notesReadonly.style.display = 'block';
                noteTitle.disabled = true;
                saveNoteBtn.disabled = true;
                
                // Update the read-only view
                updateNotesReadonlyView();
            } else if (mode === 'mindmap') {
                mindMapModeBtn.classList.add('active');
                mindMapContainer.style.display = 'block';
                noteTitle.disabled = true;
                saveNoteBtn.disabled = true;
                
                // Load or create mind map
                loadMindMap();
            }
        }

        function updateNotesReadonlyView() {
            if (state.currentNoteId) {
                const note = state.notes.find(n => n.id === state.currentNoteId);
                if (note) {
                    // Create a temporary container to process the HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = note.content;
                    
                    // Fix image sizes for better display in read mode
                    const images = tempDiv.querySelectorAll('img');
                    images.forEach(img => {
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';
                    });
                    
                    notesReadonly.innerHTML = tempDiv.innerHTML;
                }
            } else {
                notesReadonly.innerHTML = '<p class="empty-state">No note selected. Create or select a note to view.</p>';
            }
        }

        // Timer functions
        function startTimer() {
            if (timerRunning) return;
            
            timerRunning = true;
            timerInterval = setInterval(updateTimer, 1000);
            startTimerBtn.disabled = true;
            pauseTimerBtn.disabled = false;
            
            // Update last activity
            state.lastActivityDate = new Date().toISOString();
            saveState();
        }

        function pauseTimer() {
            if (!timerRunning) return;
            
            timerRunning = false;
            clearInterval(timerInterval);
            startTimerBtn.disabled = false;
            pauseTimerBtn.disabled = true;
            
            // Save timer state for resume
            state.lastTimerState = {
                minutes: timerMinutes,
                seconds: timerSeconds,
                mode: timerMode,
                running: false
            };
            saveState();
        }

        function resetTimer() {
            pauseTimer();
            timerMinutes = parseInt(document.querySelector('.mode-btn.active').getAttribute('data-minutes'));
            timerSeconds = 0;
            extendedSession = false;
            updateTimerDisplay();
            startTimerBtn.disabled = false;
            pauseTimerBtn.disabled = true;
            
            // Save timer state for resume
            state.lastTimerState = {
                minutes: timerMinutes,
                seconds: timerSeconds,
                mode: timerMode,
                running: false
            };
            saveState();
        }

        function skipBreak() {
            if (timerMode === 'shortBreak' || timerMode === 'longBreak') {
                resetTimer();
                // Set to focus mode
                modeButtons[0].click();
                showToast('Break skipped! Ready for another focus session?');
            } else {
                showToast('You can only skip breaks, not focus sessions', 'error');
            }
        }

        function extendSession() {
            if (timerMode === 'focus' && !extendedSession) {
                timerMinutes += 15;
                extendedSession = true;
                updateTimerDisplay();
                showToast('Session extended by 15 minutes! Keep up the great work!');
            } else if (extendedSession) {
                showToast('Session already extended', 'error');
            } else {
                showToast('You can only extend focus sessions', 'error');
            }
        }

        function updateTimer() {
            if (timerSeconds === 0) {
                if (timerMinutes === 0) {
                    // Timer completed
                    clearInterval(timerInterval);
                    timerRunning = false;
                    handleTimerComplete();
                    return;
                }
                timerMinutes--;
                timerSeconds = 59;
            } else {
                timerSeconds--;
            }
            
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const displayMinutes = timerMinutes.toString().padStart(2, '0');
            const displaySeconds = timerSeconds.toString().padStart(2, '0');
            timerDisplay.textContent = `${displayMinutes}:${displaySeconds}`;
            timerPreviewDisplay.textContent = `${displayMinutes}:${displaySeconds}`;
            
            // Update circular progress
            const totalSeconds = timerMode === 'focus' ? (extendedSession ? 40 : 25) * 60 : 
                               timerMode === 'shortBreak' ? 5 * 60 : 15 * 60;
            const elapsedSeconds = (timerMode === 'focus' ? (extendedSession ? 40 : 25) - timerMinutes : 
                                  timerMode === 'shortBreak' ? 5 - timerMinutes : 15 - timerMinutes) * 60 - (60 - timerSeconds);
            const progress = (elapsedSeconds / totalSeconds) * 226;
            document.querySelector('.circular-fill').style.strokeDashoffset = 226 - progress;
        }

        function handleTimerComplete() {
            // Award XP based on timer mode
            let xpEarned = 0;
            if (timerMode === 'focus') {
                xpEarned = extendedSession ? 75 : 50;
                
                // Apply power-up bonuses
                if (state.emojiPowerUps.dragon.active) {
                    xpEarned *= state.emojiPowerUps.dragon.xpMultiplier;
                }
                if (state.emojiPowerUps.rocket.active) {
                    xpEarned *= state.emojiPowerUps.rocket.taskBonus;
                }
                
                state.timerSessions++;
                
                // Update sessions progress
                updateSessionsProgress();
                
                // Check for achievements
                checkAchievement(2); // Marathon Runner
                checkAchievement(6); // Early Bird
                checkAchievement(7); // Weekend Warrior
                
                // Check for surprise rewards
                checkSurpriseRewards();
                
                // Update emoji level based on XP
                updateEmojiLevelBasedOnXP();
            } else if (timerMode === 'shortBreak') {
                xpEarned = 10;
            } else if (timerMode === 'longBreak') {
                xpEarned = 25;
            }
            
            awardXP(xpEarned);
            
            // Update study streak
            updateStreak();
            
            // Show completion message
            const sessionType = extendedSession ? 'Extended Focus' : (timerMode === 'focus' ? 'Focus' : timerMode === 'shortBreak' ? 'Short Break' : 'Long Break');
            showToast(`${sessionType} session complete! You earned ${xpEarned} XP.`, 'success');
            
            // Reset extended session flag
            extendedSession = false;
            
            // Reset timer for next session
            resetTimer();
        }

        // Backup and Restore functions
        function backupData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `studyquest-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Backup created successfully!');
        }

        function copyDataToClipboard() {
            const dataStr = JSON.stringify(state, null, 2);
            
            // Use the Clipboard API if available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(dataStr)
                    .then(() => {
                        showToast('Data copied to clipboard!');
                    })
                    .catch(err => {
                        console.error('Failed to copy data: ', err);
                        fallbackCopyToClipboard(dataStr);
                    });
            } else {
                fallbackCopyToClipboard(dataStr);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Data copied to clipboard!');
                } else {
                    showToast('Failed to copy data to clipboard', 'error');
                }
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                showToast('Failed to copy data to clipboard', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        function restoreData() {
            const file = restoreFileInput.files[0];
            if (!file) {
                showToast('Please select a backup file first', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to restore from backup? This will overwrite all current data.')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate the backup data structure
                    if (backupData && typeof backupData === 'object') {
                        state = { ...state, ...backupData };
                        saveState();
                        
                        // Reload the application
                        location.reload();
                    } else {
                        showToast('Invalid backup file format', 'error');
                    }
                } catch (error) {
                    console.error('Error parsing backup file:', error);
                    showToast('Error reading backup file', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Settings functions
        function saveProfile() {
            const username = settingsUsername.value.trim();
            const spaceName = studySpaceName.value.trim();
            
            if (!username) {
                showToast('Please enter a username', 'error');
                return;
            }
            
            state.username = username;
            state.studySpaceName = spaceName || "My Study Space";
            document.getElementById('user-name').textContent = username;
            document.getElementById('user-avatar').textContent = username.substring(0, 2).toUpperCase();
            
            saveState();
            showToast('Profile updated successfully!');
        }

        function setTheme(theme) {
            state.theme = theme;
            
            // Update theme options
            themeOptions.forEach(option => {
                if (option.getAttribute('data-theme') === theme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            applyTheme();
            saveState();
        }

        function applyTheme() {
            if (state.theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
        }

        // Enhanced Feature Functions

        // Focus Emoji Functions
        function setupFocusEmoji() {
            focusEmoji.textContent = state.focusEmoji;
            updateEmojiLevel(state.emojiLevel);
            checkPowerUps();
        }

        function handleEmojiClick() {
            // Bounce animation
            focusEmoji.classList.add('bounce');
            setTimeout(() => {
                focusEmoji.classList.remove('bounce');
            }, 500);
            
            // Show random message
            const messages = [
                "Keep going! You're doing great!",
                "Stay focused! You've got this!",
                "Every minute counts!",
                "You're building great habits!",
                "Your future self will thank you!",
                "Knowledge is power!",
                "Small steps lead to big achievements!",
                "You're on fire! "
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            showEmojiMessage(randomMessage);
            
            // Chance to activate power-up
            if (Math.random() < 0.1) { // 10% chance
                activateRandomPowerUp();
            }
        }

        function showEmojiMessage(message) {
            emojiMessage.textContent = message;
            emojiMessage.classList.add('show');
            
            setTimeout(() => {
                emojiMessage.classList.remove('show');
            }, 3000);
        }

        function activateEmojiPowerUp(emoji) {
            // Deactivate all power-ups first
            Object.keys(state.emojiPowerUps).forEach(powerUp => {
                state.emojiPowerUps[powerUp].active = false;
            });
            
            // Activate the power-up for the selected emoji
            let powerUpType = '';
            switch(emoji) {
                case '':
                    powerUpType = 'dragon';
                    break;
                case '':
                    powerUpType = 'owl';
                    break;
                case '':
                    powerUpType = 'rocket';
                    break;
                case '':
                    powerUpType = 'brain';
                    break;
            }
            
            if (powerUpType) {
                state.emojiPowerUps[powerUpType].active = true;
                state.emojiPowerUps[powerUpType].endTime = new Date().getTime() + (30 * 60 * 1000);
                
                // Show power-up indicator
                emojiPowerUpIndicator.style.display = 'flex';
                focusEmoji.classList.add('power-up');
                
                // Show notification
                const powerUpNames = {
                    dragon: 'Dragon Power-Up',
                    owl: 'Owl Power-Up',
                    rocket: 'Rocket Power-Up',
                    brain: 'Brain Power-Up'
                };
                
                showToast(` ${powerUpNames[powerUpType]} activated! Bonus effects for 30 minutes!`, 'success');
                
                saveState();
            }
        }

        function activateRandomPowerUp() {
            const powerUps = ['dragon', 'owl', 'rocket', 'brain'];
            const randomPowerUp = powerUps[Math.floor(Math.random() * powerUps.length)];
            
            // Activate the power-up for 30 minutes
            state.emojiPowerUps[randomPowerUp].active = true;
            state.emojiPowerUps[randomPowerUp].endTime = new Date().getTime() + (30 * 60 * 1000);
            
            // Show power-up indicator
            emojiPowerUpIndicator.style.display = 'flex';
            focusEmoji.classList.add('power-up');
            
            // Show notification
            const powerUpNames = {
                dragon: 'Dragon Power-Up',
                owl: 'Owl Power-Up',
                rocket: 'Rocket Power-Up',
                brain: 'Brain Power-Up'
            };
            
            showToast(` ${powerUpNames[randomPowerUp]} activated! Bonus effects for 30 minutes!`, 'success');
            
            saveState();
        }

        function checkPowerUps() {
            const now = new Date().getTime();
            let anyActive = false;
            
            Object.keys(state.emojiPowerUps).forEach(powerUp => {
                if (state.emojiPowerUps[powerUp].active && state.emojiPowerUps[powerUp].endTime < now) {
                    // Power-up expired
                    state.emojiPowerUps[powerUp].active = false;
                }
                
                if (state.emojiPowerUps[powerUp].active) {
                    anyActive = true;
                }
            });
            
            // Update UI
            if (anyActive) {
                emojiPowerUpIndicator.style.display = 'flex';
                focusEmoji.classList.add('power-up');
            } else {
                emojiPowerUpIndicator.style.display = 'none';
                focusEmoji.classList.remove('power-up');
            }
            
            saveState();
        }

        function updateEmojiLevel(level) {
            state.emojiLevel = level;
            emojiEvolution.textContent = `Lv. ${level}`;
            
            if (level > 1) {
                focusEmoji.classList.add('evolved');
            } else {
                focusEmoji.classList.remove('evolved');
            }
            
            saveState();
        }

        function updateEmojiLevelBasedOnXP() {
            const newLevel = Math.floor(state.xp / 1000) + 1;
            if (newLevel > state.emojiLevel) {
                updateEmojiLevel(newLevel);
                showEmojiMessage(`Level up! Your focus emoji is now level ${newLevel}!`);
            }
        }

        // Environment Functions
        function setupEnvironment() {
            setEnvironment(state.environment);
        }

        function setEnvironment(environment) {
            state.environment = environment;
            
            // Update environment options
            environmentOptions.forEach(option => {
                if (option.getAttribute('data-environment') === environment) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // Clear existing effects
            environmentEffects.innerHTML = '';
            
            // Apply environment effects
            if (environment === 'clear') {
                document.body.style.background = 'linear-gradient(135deg, var(--primary-dark), var(--primary))';
            } else if (environment === 'night') {
                document.body.style.background = 'linear-gradient(135deg, #0a0a1a, #1a1a2e)';
            }
            
            saveState();
        }

        // Mind Map Functions - Fixed
        function setupMindMap() {
            // Initialize mind map functionality
        }

        function loadMindMap() {
            if (!state.currentNoteId) {
                mindMapContainer.innerHTML = '<p class="empty-state">No note selected. Create or select a note to create a mind map.</p>';
                return;
            }
            
            // Check if we already have a mind map for this note
            let mindMap = state.mindMaps.find(m => m.noteId === state.currentNoteId);
            
            if (!mindMap) {
                // Create a new mind map
                mindMap = {
                    id: generateId(),
                    noteId: state.currentNoteId,
                    nodes: [
                        {
                            id: generateId(),
                            content: noteTitle.value || 'Central Idea',
                            x: 200,
                            y: 200
                        }
                    ],
                    connections: []
                };
                state.mindMaps.push(mindMap);
                saveState();
            }
            
            state.currentMindMap = mindMap;
            renderMindMap();
        }

        function renderMindMap() {
            if (!state.currentMindMap) return;
            
            mindMapContainer.innerHTML = '';
            
            // Render connections
            state.currentMindMap.connections.forEach(connection => {
                const fromNode = state.currentMindMap.nodes.find(n => n.id === connection.from);
                const toNode = state.currentMindMap.nodes.find(n => n.id === connection.to);
                
                if (fromNode && toNode) {
                    const connectionEl = document.createElement('div');
                    connectionEl.className = 'mind-map-connection';
                    
                    const dx = toNode.x - fromNode.x;
                    const dy = toNode.y - fromNode.y;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    
                    connectionEl.style.width = `${length}px`;
                    connectionEl.style.transform = `rotate(${angle}deg)`;
                    connectionEl.style.left = `${fromNode.x + 60}px`;
                    connectionEl.style.top = `${fromNode.y + 30}px`;
                    
                    mindMapContainer.appendChild(connectionEl);
                }
            });
            
            // Render nodes
            state.currentMindMap.nodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = 'mind-map-node';
                nodeEl.style.left = `${node.x}px`;
                nodeEl.style.top = `${node.y}px`;
                nodeEl.setAttribute('data-node-id', node.id);
                
                nodeEl.innerHTML = `
                    <div class="node-content" contenteditable="true">${node.content}</div>
                    <div class="node-actions">
                        <button class="btn btn-secondary add-child-node" data-node-id="${node.id}">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-secondary delete-node" data-node-id="${node.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Make node draggable
                makeNodeDraggable(nodeEl, node);
                
                // Add event listeners
                nodeEl.querySelector('.node-content').addEventListener('blur', (e) => {
                    node.content = e.target.textContent;
                    saveState();
                });
                
                nodeEl.querySelector('.add-child-node').addEventListener('click', (e) => {
                    e.stopPropagation();
                    addChildNode(node.id);
                });
                
                nodeEl.querySelector('.delete-node').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteNode(node.id);
                });
                
                mindMapContainer.appendChild(nodeEl);
            });
        }

        function makeNodeDraggable(nodeEl, node) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            nodeEl.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('node-content') || 
                    e.target.classList.contains('add-child-node') || 
                    e.target.classList.contains('delete-node')) {
                    return;
                }
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = node.x;
                initialY = node.y;
                
                nodeEl.classList.add('active');
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            
            function onMouseMove(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                node.x = initialX + dx;
                node.y = initialY + dy;
                
                nodeEl.style.left = `${node.x}px`;
                nodeEl.style.top = `${node.y}px`;
                
                // Re-render connections
                renderMindMap();
            }
            
            function onMouseUp() {
                isDragging = false;
                nodeEl.classList.remove('active');
                
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                
                saveState();
            }
        }

        function addChildNode(parentId) {
            const parentNode = state.currentMindMap.nodes.find(n => n.id === parentId);
            if (!parentNode) return;
            
            const newNode = {
                id: generateId(),
                content: 'New Idea',
                x: parentNode.x + 200,
                y: parentNode.y
            };
            
            state.currentMindMap.nodes.push(newNode);
            state.currentMindMap.connections.push({
                from: parentId,
                to: newNode.id
            });
            
            saveState();
            renderMindMap();
        }

        function deleteNode(nodeId) {
            if (state.currentMindMap.nodes.length <= 1) {
                showToast('Cannot delete the last node', 'error');
                return;
            }
            
            state.currentMindMap.nodes = state.currentMindMap.nodes.filter(n => n.id !== nodeId);
            state.currentMindMap.connections = state.currentMindMap.connections.filter(c => 
                c.from !== nodeId && c.to !== nodeId
            );
            
            saveState();
            renderMindMap();
        }

        // Note Sharing Functions
        function copyNoteToClipboard() {
            if (!state.currentNoteId) {
                showToast('Please select or create a note first', 'error');
                return;
            }
            
            const note = state.notes.find(n => n.id === state.currentNoteId);
            if (note) {
                const noteText = `${note.title}\n\n${stripHtml(note.content)}`;
                
                // Use the Clipboard API if available
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(noteText)
                        .then(() => {
                            showToast('Note copied to clipboard!');
                        })
                        .catch(err => {
                            console.error('Failed to copy note: ', err);
                            fallbackCopyToClipboard(noteText);
                        });
                } else {
                    fallbackCopyToClipboard(noteText);
                }
            }
        }

        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function summarizeNote() {
            if (!state.currentNoteId) {
                showToast('Please select or create a note first', 'error');
                return;
            }
            
            const note = state.notes.find(n => n.id === state.currentNoteId);
            if (note) {
                // Simple summarization - in a real app, this would use an AI API
                const content = stripHtml(note.content);
                const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
                
                // Take first 3 sentences or all if less than 3
                const summary = sentences.slice(0, 3).join('. ') + '.';
                
                // Create a summary note
                const summaryNote = {
                    id: generateId(),
                    title: `Summary: ${note.title}`,
                    content: `<p>${summary}</p>`,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                state.notes.push(summaryNote);
                saveState();
                renderNotes();
                
                showToast('Note summarized successfully! A new summary note has been created.');
            }
        }

        // Smart Reminders and Predictions
        function updateSmartReminders() {
            const remindersContainer = document.getElementById('smart-reminders');
            remindersContainer.innerHTML = '';
            
            const now = new Date();
            const today = now.toDateString();
            const lastActivity = state.lastActivityDate ? new Date(state.lastActivityDate) : null;
            
            // Check if user hasn't studied today
            if (lastActivity && lastActivity.toDateString() !== today && state.streak > 0) {
                const reminder = document.createElement('div');
                reminder.className = 'reminder-item warning';
                reminder.innerHTML = `
                    <div class="reminder-header">
                        <div class="reminder-title">
                            <i class="fas fa-fire"></i>
                            Streak at Risk!
                        </div>
                    </div>
                    <div class="reminder-desc">
                        Haven't seen you today! Your ${state.streak}-day streak is at risk 
                    </div>
                    <div class="reminder-actions">
                        <button class="reminder-action-btn start-study-reminder">
                            <i class="fas fa-play"></i> Start Studying
                        </button>
                    </div>
                `;
                remindersContainer.appendChild(reminder);
                
                // Add event listener to start studying button
                reminder.querySelector('.start-study-reminder').addEventListener('click', () => {
                    startTimerFromDashboard.click();
                });
            }
            
            // Check for scheduled study times
            const currentHour = now.getHours();
            const currentDay = now.getDay() === 0 ? 7 : now.getDay(); // Convert to 1-7 (Mon-Sun)
            
            const upcomingClasses = state.classes.filter(c => c.day === currentDay && c.time > currentHour)
                                               .sort((a, b) => a.time - b.time);
            
            if (upcomingClasses.length > 0) {
                const nextClass = upcomingClasses[0];
                const reminder = document.createElement('div');
                reminder.className = 'reminder-item';
                reminder.innerHTML = `
                    <div class="reminder-header">
                        <div class="reminder-title">
                            <i class="fas fa-clock"></i>
                            Upcoming Class
                        </div>
                    </div>
                    <div class="reminder-desc">
                        You have ${nextClass.subject} at ${nextClass.time}:00 - want to start a timer?
                    </div>
                    <div class="reminder-actions">
                        <button class="reminder-action-btn start-timer-reminder">
                            <i class="fas fa-play"></i> Start Timer
                        </button>
                    </div>
                `;
                remindersContainer.appendChild(reminder);
                
                // Add event listener to start timer button
                reminder.querySelector('.start-timer-reminder').addEventListener('click', () => {
                    startTimerFromDashboard.click();
                });
            }
            
            // Check for upcoming tasks
            const upcomingTasks = state.tasks.filter(t => !t.completed && new Date(t.due) >= new Date())
                                           .sort((a, b) => new Date(a.due) - new Date(b.due));
            
            if (upcomingTasks.length > 0) {
                const nextTask = upcomingTasks[0];
                const dueDate = new Date(nextTask.due);
                const daysUntilDue = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                
                if (daysUntilDue <= 3) {
                    const reminder = document.createElement('div');
                    reminder.className = 'reminder-item warning';
                    reminder.innerHTML = `
                        <div class="reminder-header">
                            <div class="reminder-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Task Deadline Approaching
                            </div>
                        </div>
                        <div class="reminder-desc">
                            ${daysUntilDue} day${daysUntilDue !== 1 ? 's' : ''} until "${nextTask.title}" is due
                        </div>
                    `;
                    remindersContainer.appendChild(reminder);
                }
            }
            
            // If no reminders, show default message
            if (remindersContainer.children.length === 0) {
                remindersContainer.innerHTML = '<div class="empty-state">Complete tasks and study sessions to get personalized reminders!</div>';
            }
        }

        function updateStudyPredictions() {
            const predictionsContainer = document.getElementById('study-predictions');
            predictionsContainer.innerHTML = '';
            
            // Calculate average study time per day
            const studySessions = state.timerSessions;
            const daysActive = state.streak > 0 ? state.streak : 1;
            const avgSessionsPerDay = studySessions / daysActive;
            
            if (studySessions > 0) {
                // Prediction 1: Time to complete syllabus (simplified)
                const remainingSessions = 20; // Example value
                const daysToComplete = Math.ceil(remainingSessions / avgSessionsPerDay);
                
                const prediction1 = document.createElement('div');
                prediction1.className = 'reminder-item success';
                prediction1.innerHTML = `
                    <div class="reminder-header">
                        <div class="reminder-title">
                            <i class="fas fa-chart-line"></i>
                            Study Prediction
                        </div>
                    </div>
                    <div class="reminder-desc">
                        At this pace, you'll complete the syllabus in ${daysToComplete} day${daysToComplete !== 1 ? 's' : ''}
                    </div>
                `;
                predictionsContainer.appendChild(prediction1);
                
                // Prediction 2: Daily goal progress
                const dailyGoal = 4; // Example: 4 sessions per day
                const sessionsToday = state.timerSessions; // This would need to be tracked per day
                const sessionsNeeded = dailyGoal - sessionsToday;
                
                if (sessionsNeeded > 0) {
                    const prediction2 = document.createElement('div');
                    prediction2.className = 'reminder-item';
                    prediction2.innerHTML = `
                        <div class="reminder-header">
                            <div class="reminder-title">
                                <i class="fas fa-bullseye"></i>
                                Daily Goal
                            </div>
                        </div>
                        <div class="reminder-desc">
                            You need ${sessionsNeeded} more session${sessionsNeeded !== 1 ? 's' : ''} to reach your daily goal
                        </div>
                    `;
                    predictionsContainer.appendChild(prediction2);
                }
            } else {
                predictionsContainer.innerHTML = '<div class="empty-state">Complete more study sessions to get personalized predictions!</div>';
            }
        }

        function checkSurpriseRewards() {
            // Only check during focus sessions
            if (timerRunning && timerMode === 'focus') {
                // 5% chance of surprise reward every 30 seconds
                if (Math.random() < 0.05) {
                    const rewards = [
                        { type: 'xp', amount: 25, message: 'Bonus XP! Keep up the great work!' },
                        { type: 'resource', message: 'Lucky find! Check your resources for something new.' },
                        { type: 'productivity', message: 'Productivity Spike! You\'re in the zone!' }
                    ];
                    
                    const reward = rewards[Math.floor(Math.random() * rewards.length)];
                    
                    if (reward.type === 'xp') {
                        awardXP(reward.amount);
                    } else if (reward.type === 'resource') {
                        // Add a random resource
                        const sampleResources = [
                            { name: "Khan Academy - Math", url: "https://www.khanacademy.org/math", category: "website" },
                            { name: "Crash Course - History", url: "https://www.youtube.com/user/crashcourse", category: "video" },
                            { name: "Study Tips PDF", url: "#", category: "pdf" }
                        ];
                        
                        const newResource = sampleResources[Math.floor(Math.random() * sampleResources.length)];
                        if (!state.resources.some(r => r.name === newResource.name)) {
                            state.resources.push({
                                id: generateId(),
                                ...newResource,
                                description: "Discovered while studying!"
                            });
                            saveState();
                            renderResources();
                        }
                    }
                    
                    showToast(` ${reward.message}`, 'success');
                    addNotification(`Surprise Reward: ${reward.message}`);
                    
                    // Add to surprise rewards history
                    state.surpriseRewards.push({
                        type: reward.type,
                        message: reward.message,
                        timestamp: new Date().toISOString()
                    });
                    saveState();
                }
            }
        }

        // Rendering functions
        function renderAll() {
            renderTasks();
            renderNotes();
            renderTimetable();
            renderTodaySchedule();
            renderCalendar();
            renderSubjects();
            renderResources();
            renderAchievements();
            updateTaskSubjectSelect();
        }

        function renderTasks() {
            // Clear task lists
            taskList.innerHTML = '';
            dashboardTasks.innerHTML = '';
            
            if (state.tasks.length === 0) {
                taskList.innerHTML = '<li class="empty-state">No tasks yet. Add your first task to get started!</li>';
                dashboardTasks.innerHTML = '<li class="empty-state">No upcoming tasks. Add a task to get started!</li>';
                return;
            }
            
            // Sort tasks: incomplete first, then by due date
            const sortedTasks = [...state.tasks].sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                return new Date(a.due) - new Date(b.due);
            });
            
            // Render tasks in task manager
            sortedTasks.forEach(task => {
                const taskItem = document.createElement('li');
                taskItem.className = 'task-item';
                if (task.completed) taskItem.style.opacity = '0.7';
                
                const dueDate = new Date(task.due);
                const formattedDate = dueDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                taskItem.innerHTML = `
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" data-task-id="${task.id}">
                        ${task.completed ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                    <div class="task-info">
                        <div class="task-title">${task.title}</div>
                        <div class="task-due">Due: ${formattedDate}</div>
                        ${task.description ? `<div class="task-desc">${task.description}</div>` : ''}
                    </div>
                    <div class="task-actions">
                        <button class="task-btn edit-task" data-task-id="${task.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="task-btn delete-task" data-task-id="${task.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                taskList.appendChild(taskItem);
            });
            
            // Render upcoming tasks in dashboard (only incomplete, max 3)
            const upcomingTasks = sortedTasks
                .filter(task => !task.completed)
                .slice(0, 3);
                
            if (upcomingTasks.length === 0) {
                dashboardTasks.innerHTML = '<li class="empty-state">No upcoming tasks. Add a task to get started!</li>';
                return;
            }
                
            upcomingTasks.forEach(task => {
                const taskItem = document.createElement('li');
                taskItem.className = 'task-item';
                
                const dueDate = new Date(task.due);
                const formattedDate = dueDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                taskItem.innerHTML = `
                    <div class="task-checkbox" data-task-id="${task.id}">
                    </div>
                    <div class="task-info">
                        <div class="task-title">${task.title}</div>
                        <div class="task-due">Due: ${formattedDate}</div>
                    </div>
                `;
                
                dashboardTasks.appendChild(taskItem);
            });
            
            // Add event listeners to task checkboxes
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', (e) => {
                    const taskId = checkbox.getAttribute('data-task-id');
                    toggleTaskCompletion(taskId);
                });
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-task').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = btn.getAttribute('data-task-id');
                    editTask(taskId);
                });
            });
            
            document.querySelectorAll('.delete-task').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = btn.getAttribute('data-task-id');
                    // Remove the task directly without checking completion status
                    if (confirm('Are you sure you want to delete this task?')) {
                        state.tasks = state.tasks.filter(t => t.id !== taskId);
                        saveState();
                        renderTasks();
                        showToast('Task deleted successfully!');
                    }
                });
            });
        }

        function renderNotes() {
            notesList.innerHTML = '';
            
            if (state.notes.length === 0) {
                notesList.innerHTML = '<div class="empty-state">No notes yet. Create your first note!</div>';
                return;
            }
            
            // Sort notes by updated date (newest first)
            const sortedNotes = [...state.notes].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            sortedNotes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = `note-item ${state.currentNoteId === note.id ? 'active' : ''}`;
                noteItem.setAttribute('data-note-id', note.id);
                
                // Create a preview of the note content (text only, no HTML)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = note.content;
                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                const preview = textContent.length > 100 ? textContent.substring(0, 100) + '...' : textContent;
                
                const updatedDate = new Date(note.updatedAt);
                const formattedDate = updatedDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
                
                noteItem.innerHTML = `
                    <div class="note-title">${note.title}</div>
                    <div class="note-preview">${preview}</div>
                    <div class="note-date">Updated: ${formattedDate}</div>
                `;
                
                noteItem.addEventListener('click', () => {
                    loadNoteForEditing(note.id);
                });
                
                notesList.appendChild(noteItem);
            });
        }

        function renderTimetable() {
            timetableGrid.innerHTML = '';
            
            // Create header row
            timetableGrid.innerHTML = `
                <div class="time-slot"></div>
                <div class="day-header">Mon</div>
                <div class="day-header">Tue</div>
                <div class="day-header">Wed</div>
                <div class="day-header">Thu</div>
                <div class="day-header">Fri</div>
                <div class="day-header">Sat</div>
                <div class="day-header">Sun</div>
            `;
            
            // Create time slots (8 AM to 5 PM)
            for (let hour = 8; hour <= 17; hour++) {
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = `${hour}:00`;
                timetableGrid.appendChild(timeSlot);
                
                // Create cells for each day
                for (let day = 1; day <= 7; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'timetable-cell';
                    cell.setAttribute('data-day', day);
                    cell.setAttribute('data-time', hour);
                    
                    // Check if there's a class at this time
                    const classAtThisTime = state.classes.find(c => c.day === day && c.time === hour);
                    if (classAtThisTime) {
                        cell.classList.add('has-class');
                        cell.style.borderLeftColor = classAtThisTime.color;
                        cell.innerHTML = `
                            <div class="class-subject">${classAtThisTime.subject}</div>
                            <div class="class-topic">${classAtThisTime.topic}</div>
                        `;
                    }
                    
                    cell.addEventListener('click', () => {
                        editClassAtTime(day, hour);
                    });
                    
                    timetableGrid.appendChild(cell);
                }
            }
        }

        function renderTodaySchedule() {
            todaySchedule.innerHTML = '';
            
            const today = new Date().getDay();
            // Convert Sunday (0) to 7 for our day system
            const todayAdjusted = today === 0 ? 7 : today;
            
            const todayClasses = state.classes.filter(c => c.day === todayAdjusted)
                                              .sort((a, b) => a.time - b.time);
            
            if (todayClasses.length === 0) {
                todaySchedule.innerHTML = '<p class="empty-state">No classes scheduled for today. Add some in the Timetable!</p>';
                return;
            }
            
            todayClasses.forEach(classItem => {
                const classElement = document.createElement('div');
                classElement.className = 'class-item';
                classElement.innerHTML = `
                    <div class="class-time">${classItem.time}:00 - ${classItem.time + 1}:00</div>
                    <div class="class-info">
                        <div class="class-subject">${classItem.subject}</div>
                        <div class="class-topic">${classItem.topic}</div>
                    </div>
                `;
                classElement.style.borderLeft = `4px solid ${classItem.color}`;
                todaySchedule.appendChild(classElement);
            });
        }

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            
            // Create day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyCell);
            }
            
            // Add cells for each day of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.innerHTML = `<div class="day-number">${day}</div>`;
                
                // Check if there are events on this day
                const dateStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const dayEvents = state.events.filter(e => e.date === dateStr);
                
                dayEvents.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'calendar-event';
                    eventElement.textContent = event.title;
                    eventElement.title = event.description;
                    eventElement.setAttribute('data-event-id', event.id);
                    dayCell.appendChild(eventElement);
                    
                    // Add click event to delete events
                    eventElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`Delete event "${event.title}"?`)) {
                            state.events = state.events.filter(ev => ev.id !== event.id);
                            saveState();
                            renderCalendar();
                            showToast('Event deleted successfully!');
                        }
                    });
                });
                
                // Add click event to add events
                dayCell.addEventListener('click', () => {
                    addEventOnDate(dateStr);
                });
                
                calendarGrid.appendChild(dayCell);
            }
            
            // Update calendar header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.querySelector('#calendar .widget-title').innerHTML = `
                <i class="fas fa-calendar"></i>
                ${monthNames[currentMonth]} ${currentYear}
            `;
        }

        function renderSubjects() {
            subjectsGrid.innerHTML = '';
            
            if (state.subjects.length === 0) {
                subjectsGrid.innerHTML = '<div class="empty-state">No subjects added yet. Add your first subject!</div>';
                return;
            }
            
            state.subjects.forEach(subject => {
                const subjectCard = document.createElement('div');
                subjectCard.className = 'widget';
                subjectCard.innerHTML = `
                    <div class="widget-header">
                        <h2 class="widget-title">
                            <i class="fas fa-book" style="color: ${subject.color}"></i>
                            ${subject.name}
                        </h2>
                        <button class="btn btn-secondary edit-subject" data-subject-id="${subject.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="widget-content">
                        <h3 style="margin-bottom: 10px;">Resources</h3>
                        ${subject.resources.length > 0 ? 
                            `<ul class="resource-list">
                                ${subject.resources.map(resource => 
                                    `<li><a href="${resource}" target="_blank">${resource}</a></li>`
                                ).join('')}
                            </ul>` : 
                            '<p class="empty-state">No resources added yet.</p>'
                        }
                    </div>
                `;
                
                subjectsGrid.appendChild(subjectCard);
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-subject').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const subjectId = btn.getAttribute('data-subject-id');
                    editSubject(subjectId);
                });
            });
        }

        function renderResources() {
            resourcesContainer.innerHTML = '';
            
            if (state.resources.length === 0) {
                resourcesContainer.innerHTML = '<div class="empty-state">No resources added yet. Add your first resource!</div>';
                return;
            }
            
            // Group resources by category
            const resourcesByCategory = {};
            state.resources.forEach(resource => {
                if (!resourcesByCategory[resource.category]) {
                    resourcesByCategory[resource.category] = [];
                }
                resourcesByCategory[resource.category].push(resource);
            });
            
            // Render resources by category
            Object.keys(resourcesByCategory).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'resource-category';
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = category.charAt(0).toUpperCase() + category.slice(1) + ' Resources';
                categoryDiv.appendChild(categoryTitle);
                
                resourcesByCategory[category].forEach(resource => {
                    const resourceItem = document.createElement('div');
                    resourceItem.className = 'resource-item';
                    
                    // Get appropriate icon for category
                    let icon = 'fa-link';
                    if (category === 'pdf') icon = 'fa-file-pdf';
                    else if (category === 'video') icon = 'fa-video';
                    else if (category === 'book') icon = 'fa-book';
                    else if (category === 'article') icon = 'fa-newspaper';
                    
                    resourceItem.innerHTML = `
                        <div class="resource-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="resource-info">
                            <div class="resource-name">${resource.name}</div>
                            <div class="resource-desc">${resource.description || resource.url}</div>
                        </div>
                        <div class="resource-actions">
                            <button class="btn btn-secondary open-resource" data-resource-url="${resource.url}">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            <button class="btn btn-secondary edit-resource" data-resource-id="${resource.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-secondary delete-resource" data-resource-id="${resource.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    categoryDiv.appendChild(resourceItem);
                });
                
                resourcesContainer.appendChild(categoryDiv);
            });
            
            // Add event listeners
            document.querySelectorAll('.open-resource').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const url = btn.getAttribute('data-resource-url');
                    window.open(url, '_blank');
                });
            });
            
            document.querySelectorAll('.edit-resource').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const resourceId = btn.getAttribute('data-resource-id');
                    editResource(resourceId);
                });
            });
            
            document.querySelectorAll('.delete-resource').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const resourceId = btn.getAttribute('data-resource-id');
                    if (confirm('Are you sure you want to delete this resource?')) {
                        state.resources = state.resources.filter(r => r.id !== resourceId);
                        saveState();
                        renderResources();
                        showToast('Resource deleted successfully!');
                    }
                });
            });
        }

        function renderAchievements() {
            achievementsGrid.innerHTML = '';
            
            state.achievements.forEach(achievement => {
                const achievementCard = document.createElement('div');
                achievementCard.className = `achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                
                achievementCard.innerHTML = `
                    <div class="achievement-icon">
                        <i class="fas ${achievement.icon}"></i>
                    </div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                    ${!achievement.unlocked ? 
                        `<div class="achievement-progress">${achievement.progress}/${achievement.target}</div>` : 
                        ''
                    }
                `;
                
                achievementsGrid.appendChild(achievementCard);
            });
        }

        // Helper functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function updateStats() {
            xpCount.textContent = state.xp.toLocaleString();
            streakCount.textContent = state.streak;
            levelCount.textContent = state.level;
            userLevel.textContent = state.level;
            
            // Update XP progress
            const xpForNextLevel = state.level * 500;
            const xpInCurrentLevel = state.xp - ((state.level - 1) * 500);
            const xpProgress = (xpInCurrentLevel / xpForNextLevel) * 100;
            
            xpProgressText.textContent = `${xpInCurrentLevel}/${xpForNextLevel}`;
            xpProgressBar.style.width = `${xpProgress}%`;
        }

        function updateSessionsProgress() {
            sessionsCount.textContent = state.timerSessions;
            const sessionsProgressValue = (state.timerSessions / 5) * 100;
            sessionsProgress.style.width = `${Math.min(sessionsProgressValue, 100)}%`;
        }

        function updateTaskSubjectSelect() {
            taskSubjectSelect.innerHTML = '<option value="">No Subject</option>';
            state.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                taskSubjectSelect.appendChild(option);
            });
        }

        function awardXP(amount) {
            state.xp += amount;
            
            // Check for level up
            const newLevel = Math.floor(state.xp / 500) + 1;
            if (newLevel > state.level) {
                state.level = newLevel;
                showToast(` Level Up! You've reached Level ${state.level}!`, 'success');
            }
            
            updateStats();
            saveState();
        }

        function updateStreak() {
            const today = new Date().toDateString();
            
            if (state.lastStudyDate !== today) {
                // Check if yesterday was studied (for streak continuation)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                if (state.lastStudyDate === yesterdayStr) {
                    state.streak++;
                } else {
                    state.streak = 1;
                }
                
                state.lastStudyDate = today;
                updateStats();
                saveState();
                
                // Check for streak achievement
                checkAchievement(3); // Consistency is Key
            }
        }

        function checkStreak() {
            const today = new Date().toDateString();
            
            if (state.lastStudyDate === today) {
                // Already studied today, streak continues
                return;
            }
            
            // Check if streak should be reset (missed a day)
            if (state.lastStudyDate) {
                const lastStudy = new Date(state.lastStudyDate);
                const todayObj = new Date();
                const diffTime = Math.abs(todayObj - lastStudy);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 1) {
                    state.streak = 0;
                    updateStats();
                    saveState();
                }
            }
        }

        function checkAchievement(achievementId) {
            const achievement = state.achievements.find(a => a.id === achievementId);
            if (!achievement || achievement.unlocked) return;
            
            let shouldUnlock = false;
            
            switch (achievementId) {
                case 1: // First Step
                    achievement.progress = state.tasks.filter(t => t.completed).length;
                    shouldUnlock = achievement.progress >= achievement.target;
                    break;
                case 2: // Marathon Runner
                    achievement.progress = state.timerSessions;
                    shouldUnlock = achievement.progress >= achievement.target;
                    break;
                case 3: // Consistency is Key
                    achievement.progress = state.streak;
                    shouldUnlock = achievement.progress >= achievement.target;
                    break;
                case 4: // Subject Master
                    // This would require tracking study sessions per subject
                    // For demo, we'll use a random progress
                    achievement.progress = Math.min(achievement.progress + 1, achievement.target);
                    shouldUnlock = achievement.progress >= achievement.target;
                    break;
                case 5: // Task Crusher
                    achievement.progress = state.tasks.filter(t => t.completed).length;
                    shouldUnlock = achievement.progress >= achievement.target;
                    break;
                case 6: // Early Bird
                    const now = new Date();
                    if (now.getHours() < 8) {
                        achievement.progress = 1;
                        shouldUnlock = true;
                    }
                    break;
                case 7: // Weekend Warrior
                    const today = new Date();
                    if (today.getDay() === 0 || today.getDay() === 6) {
                        achievement.progress = 1;
                        shouldUnlock = true;
                    }
                    break;
                case 8: // Perfect Week
                    // This would require tracking timetable completion
                    // For demo, we'll use a random chance
                    if (Math.random() > 0.7) {
                        achievement.progress = 1;
                        shouldUnlock = true;
                    }
                    break;
            }
            
            if (shouldUnlock && !achievement.unlocked) {
                achievement.unlocked = true;
                awardXP(100); // Bonus XP for achievements
                showToast(` Achievement Unlocked: ${achievement.name}!`, 'success');
                renderAchievements();
                addNotification(`Achievement Unlocked: ${achievement.name}`);
                saveState();
            }
        }

        function addNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification-item';
            notification.innerHTML = `
                <div class="notification-icon" style="color: var(--accent);">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Achievement Unlocked!</div>
                    <div class="notification-desc">${message}</div>
                </div>
            `;
            
            notificationList.insertBefore(notification, notificationList.firstChild);
            
            // Limit to 5 notifications
            if (notificationList.children.length > 5) {
                notificationList.removeChild(notificationList.lastChild);
            }
        }

        function toggleTaskCompletion(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                
                // Award XP for completing a task
                if (task.completed) {
                    awardXP(25);
                    checkAchievement(1); // First Step
                    checkAchievement(5); // Task Crusher
                    addNotification(`Task completed: ${task.title}`);
                }
                
                saveState();
                renderTasks();
            }
        }

        function editTask(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                document.getElementById('task-modal-title').textContent = 'Edit Task';
                document.getElementById('edit-task-id').value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-due').value = task.due;
                document.getElementById('task-subject').value = task.subject || '';
                taskModal.classList.add('active');
            }
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                state.tasks = state.tasks.filter(t => t.id !== taskId);
                saveState();
                renderTasks();
                showToast('Task deleted successfully!');
            }
        }

        function loadNoteForEditing(noteId) {
            const note = state.notes.find(n => n.id === noteId);
            if (note) {
                noteTitle.value = note.title;
                quill.root.innerHTML = note.content;
                state.currentNoteId = noteId;
                
                // Update active note in list
                document.querySelectorAll('.note-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-note-id="${noteId}"]`).classList.add('active');
                
                // Update read-only view if in view mode
                if (state.notesViewMode === 'view') {
                    updateNotesReadonlyView();
                }
                
                // Update mind map if in mind map mode
                if (state.notesViewMode === 'mindmap') {
                    loadMindMap();
                }
            }
        }

        function editClassAtTime(day, time) {
            const existingClass = state.classes.find(c => c.day === day && c.time === time);
            
            if (existingClass) {
                document.getElementById('class-modal-title').textContent = 'Edit Class';
                document.getElementById('edit-class-id').value = existingClass.id;
                document.getElementById('class-subject').value = existingClass.subject;
                document.getElementById('class-topic').value = existingClass.topic;
                document.getElementById('class-color').value = existingClass.color;
                document.getElementById('class-day').value = existingClass.day;
                document.getElementById('class-time').value = existingClass.time;
                document.getElementById('delete-class-btn').style.display = 'block';
            } else {
                document.getElementById('class-modal-title').textContent = 'Add Class';
                document.getElementById('edit-class-id').value = '';
                document.getElementById('class-subject').value = '';
                document.getElementById('class-topic').value = '';
                document.getElementById('class-color').value = '#e94560';
                document.getElementById('class-day').value = day;
                document.getElementById('class-time').value = time;
                document.getElementById('delete-class-btn').style.display = 'none';
            }
            
            classModal.classList.add('active');
        }

        function addEventOnDate(dateStr) {
            document.getElementById('event-modal-title').textContent = 'Add Event';
            document.getElementById('edit-event-id').value = '';
            document.getElementById('event-title').value = '';
            document.getElementById('event-description').value = '';
            document.getElementById('event-date').value = dateStr;
            document.getElementById('event-time').value = '';
            document.getElementById('delete-event-btn').style.display = 'none';
            eventModal.classList.add('active');
        }

        function editSubject(subjectId) {
            const subject = state.subjects.find(s => s.id === subjectId);
            if (subject) {
                document.getElementById('subject-modal-title').textContent = 'Edit Subject';
                document.getElementById('edit-subject-id').value = subject.id;
                document.getElementById('subject-name').value = subject.name;
                document.getElementById('subject-color').value = subject.color;
                document.getElementById('subject-resources').value = subject.resources.join('\n');
                document.getElementById('delete-subject-btn').style.display = 'block';
                subjectModal.classList.add('active');
            }
        }

        function editResource(resourceId) {
            const resource = state.resources.find(r => r.id === resourceId);
            if (resource) {
                document.getElementById('resource-modal-title').textContent = 'Edit Resource';
                document.getElementById('edit-resource-id').value = resource.id;
                document.getElementById('resource-name').value = resource.name;
                document.getElementById('resource-url').value = resource.url;
                document.getElementById('resource-description').value = resource.description || '';
                document.getElementById('resource-category').value = resource.category;
                document.getElementById('delete-resource-btn').style.display = 'block';
                resourceModal.classList.add('active');
            }
        }

        function autoDeleteCompletedTasks() {
            const completedTasks = state.tasks.filter(t => t.completed);
            
            if (completedTasks.length === 0) {
                showToast('No completed tasks to delete', 'info');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${completedTasks.length} completed task(s)?`)) {
                state.tasks = state.tasks.filter(t => !t.completed);
                saveState();
                renderTasks();
                showToast(`Deleted ${completedTasks.length} completed task(s)`);
            }
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'error' ? '#e94560' : type === 'success' ? '#4cd97b' : '#0f3460'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function setupCharts() {
            // Weekly XP Chart
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'XP Earned',
                        data: [120, 190, 300, 150, 200, 180, 250],
                        backgroundColor: 'rgba(233, 69, 96, 0.7)',
                        borderColor: 'rgba(233, 69, 96, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'var(--text-light)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'var(--text-light)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--text-light)'
                            }
                        }
                    }
                }
            });

            // Subject Chart
            const subjectCtx = document.getElementById('subjectChart').getContext('2d');
            new Chart(subjectCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Math', 'Science', 'History', 'Language', 'Art'],
                    datasets: [{
                        data: [30, 25, 20, 15, 10],
                        backgroundColor: [
                            'rgba(233, 69, 96, 0.7)',
                            'rgba(76, 217, 123, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(23, 162, 184, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(233, 69, 96, 1)',
                            'rgba(76, 217, 123, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(23, 162, 184, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--text-light)'
                            }
                        }
                    }
                }
            });

            // Weekly Trend Chart
            const weeklyTrendCtx = document.getElementById('weeklyTrendChart').getContext('2d');
            new Chart(weeklyTrendCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Study Hours',
                        data: [12, 15, 18, 20],
                        backgroundColor: 'rgba(233, 69, 96, 0.2)',
                        borderColor: 'rgba(233, 69, 96, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'var(--text-light)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'var(--text-light)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--text-light)'
                            }
                        }
                    }
                }
            });
        }

        // Initialize the application
        init();
    </script>
</body>
</html>
